<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.29">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="dcterms.date" content="2026-01-13">

<title>6&nbsp; Temporal-Difference Learning (Still in Progress ðŸ”¨) â€“ Notes on Sutton &amp; Barto</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../chapters/05-monte-carlo-methods.html" rel="prev">
<script src="../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-6fc64a0c1cda8d1c841de64652c337fd.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-dark-6fc64a0c1cda8d1c841de64652c337fd.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-fb02f3c877dd64dca3cf6a6e57462b95.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../site_libs/bootstrap/bootstrap-dark-72e3104a5210017f14ac4024f5014c88.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script src="../site_libs/quarto-contrib/glightbox/glightbox.min.js"></script>
<link href="../site_libs/quarto-contrib/glightbox/glightbox.min.css" rel="stylesheet">
<link href="../site_libs/quarto-contrib/glightbox/lightbox.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-sidebar floating quarto-dark"><script id="quarto-html-before-body" type="application/javascript">
    const toggleBodyColorMode = (bsSheetEl) => {
      const mode = bsSheetEl.getAttribute("data-mode");
      const bodyEl = window.document.querySelector("body");
      if (mode === "dark") {
        bodyEl.classList.add("quarto-dark");
        bodyEl.classList.remove("quarto-light");
      } else {
        bodyEl.classList.add("quarto-light");
        bodyEl.classList.remove("quarto-dark");
      }
    }
    const toggleBodyColorPrimary = () => {
      const bsSheetEl = window.document.querySelector("link#quarto-bootstrap:not([rel=disabled-stylesheet])");
      if (bsSheetEl) {
        toggleBodyColorMode(bsSheetEl);
      }
    }
    const setColorSchemeToggle = (alternate) => {
      const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
      for (let i=0; i < toggles.length; i++) {
        const toggle = toggles[i];
        if (toggle) {
          if (alternate) {
            toggle.classList.add("alternate");
          } else {
            toggle.classList.remove("alternate");
          }
        }
      }
    };
    const toggleColorMode = (alternate) => {
      // Switch the stylesheets
      const primaryStylesheets = window.document.querySelectorAll('link.quarto-color-scheme:not(.quarto-color-alternate)');
      const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
      manageTransitions('#quarto-margin-sidebar .nav-link', false);
      if (alternate) {
        // note: dark is layered on light, we don't disable primary!
        enableStylesheet(alternateStylesheets);
        for (const sheetNode of alternateStylesheets) {
          if (sheetNode.id === "quarto-bootstrap") {
            toggleBodyColorMode(sheetNode);
          }
        }
      } else {
        disableStylesheet(alternateStylesheets);
        enableStylesheet(primaryStylesheets)
        toggleBodyColorPrimary();
      }
      manageTransitions('#quarto-margin-sidebar .nav-link', true);
      // Switch the toggles
      setColorSchemeToggle(alternate)
      // Hack to workaround the fact that safari doesn't
      // properly recolor the scrollbar when toggling (#1455)
      if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
        manageTransitions("body", false);
        window.scrollTo(0, 1);
        setTimeout(() => {
          window.scrollTo(0, 0);
          manageTransitions("body", true);
        }, 40);
      }
    }
    const disableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        stylesheet.rel = 'disabled-stylesheet';
      }
    }
    const enableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        if(stylesheet.rel !== 'stylesheet') { // for Chrome, which will still FOUC without this check
          stylesheet.rel = 'stylesheet';
        }
      }
    }
    const manageTransitions = (selector, allowTransitions) => {
      const els = window.document.querySelectorAll(selector);
      for (let i=0; i < els.length; i++) {
        const el = els[i];
        if (allowTransitions) {
          el.classList.remove('notransition');
        } else {
          el.classList.add('notransition');
        }
      }
    }
    const isFileUrl = () => {
      return window.location.protocol === 'file:';
    }
    const hasAlternateSentinel = () => {
      let styleSentinel = getColorSchemeSentinel();
      if (styleSentinel !== null) {
        return styleSentinel === "alternate";
      } else {
        return false;
      }
    }
    const setStyleSentinel = (alternate) => {
      const value = alternate ? "alternate" : "default";
      if (!isFileUrl()) {
        window.localStorage.setItem("quarto-color-scheme", value);
      } else {
        localAlternateSentinel = value;
      }
    }
    const getColorSchemeSentinel = () => {
      if (!isFileUrl()) {
        const storageValue = window.localStorage.getItem("quarto-color-scheme");
        return storageValue != null ? storageValue : localAlternateSentinel;
      } else {
        return localAlternateSentinel;
      }
    }
    const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
      const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
      const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
      let newTheme = '';
      if(authorPrefersDark) {
        newTheme = isAlternate ? baseTheme : alternateTheme;
      } else {
        newTheme = isAlternate ? alternateTheme : baseTheme;
      }
      const changeGiscusTheme = () => {
        // From: https://github.com/giscus/giscus/issues/336
        const sendMessage = (message) => {
          const iframe = document.querySelector('iframe.giscus-frame');
          if (!iframe) return;
          iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
        }
        sendMessage({
          setConfig: {
            theme: newTheme
          }
        });
      }
      const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
      if (isGiscussLoaded) {
        changeGiscusTheme();
      }
    };
    const authorPrefersDark = true;
    const queryPrefersDark = window.matchMedia('(prefers-color-scheme: dark)');
    const darkModeDefault = queryPrefersDark.matches;
    let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
    // Dark / light mode switch
    window.quartoToggleColorScheme = () => {
      // Read the current dark / light value
      let toAlternate = !hasAlternateSentinel();
      toggleColorMode(toAlternate);
      setStyleSentinel(toAlternate);
      toggleGiscusIfUsed(toAlternate, darkModeDefault);
    };
    queryPrefersDark.addEventListener("change", e => {
      if(window.localStorage.getItem("quarto-color-scheme") !== null)
        return;
      const alternate = e.matches
      toggleColorMode(alternate);
      localAlternateSentinel = e.matches ? 'alternate' : 'default'; // this is used alongside local storage!
      toggleGiscusIfUsed(alternate, darkModeDefault);
    });
    // Switch to dark mode if need be
    if (hasAlternateSentinel()) {
      toggleColorMode(true);
    } else {
      toggleColorMode(false);
    }
  </script>

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../chapters/06-temporal-difference-learning.html"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Temporal-Difference Learning (Still in Progress ðŸ”¨)</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="../">Notes on Sutton &amp; Barto</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/julxi/notes_and_solutions_reinforcement_learning" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/01-intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introduction</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/02-multi-armed-bandits.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Multi-armed Bandits</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/03-finite-markov-decision-processes.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Finite Markov Decision Processes</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/04-dynamic-programming.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Dynamic Programming</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/05-monte-carlo-methods.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Monte Carlo Methods</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/06-temporal-difference-learning.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Temporal-Difference Learning (Still in Progress ðŸ”¨)</span></span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#td-prediction" id="toc-td-prediction" class="nav-link active" data-scroll-target="#td-prediction"><span class="header-section-number">6.1</span> TD Prediction</a></li>
  <li><a href="#advantages-of-td-prediction-models" id="toc-advantages-of-td-prediction-models" class="nav-link" data-scroll-target="#advantages-of-td-prediction-models"><span class="header-section-number">6.2</span> Advantages of TD Prediction Models</a></li>
  <li><a href="#optimality-of-td0" id="toc-optimality-of-td0" class="nav-link" data-scroll-target="#optimality-of-td0"><span class="header-section-number">6.3</span> Optimality of TD(0)</a>
  <ul class="collapse">
  <li><a href="#linear-fixed-point-iteration" id="toc-linear-fixed-point-iteration" class="nav-link" data-scroll-target="#linear-fixed-point-iteration">Linear fixed point iteration</a></li>
  <li><a href="#random-walk-under-batch-updating" id="toc-random-walk-under-batch-updating" class="nav-link" data-scroll-target="#random-walk-under-batch-updating"><span class="header-section-number">6.3.1</span> Random walk under batch updating</a></li>
  </ul></li>
  <li><a href="#sarsa-on-policy-td-control" id="toc-sarsa-on-policy-td-control" class="nav-link" data-scroll-target="#sarsa-on-policy-td-control"><span class="header-section-number">6.4</span> Sarsa: On-policy TD Control</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">


<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Temporal-Difference Learning (Still in Progress ðŸ”¨)</span></h1>
</div>



<div class="quarto-title-meta">

    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">January 13, 2026</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<hr>
<p>Temporal-difference (TD) learning is a blend of dynamic programming (DP) and Monte Carlo (MC).</p>
<p>Like DP it uses learned estimates to bootstrap new estimates, but also includes experience like MC does.</p>
<section id="td-prediction" class="level2" data-number="6.1">
<h2 data-number="6.1" class="anchored" data-anchor-id="td-prediction"><span class="header-section-number">6.1</span> TD Prediction</h2>
<p>The update formula for every-visit Monte Carlo with a constant learning rate is <span id="eq-mc-update-every-visit"><span class="math display">\[
V(S_t) \gets V(S_t) + \alpha [\underbrace{G_t - V(S_t)}_\text{MC error}]
\tag{6.1}\]</span></span> where <span class="math inline">\(G_t\)</span> is the actual return following time <span class="math inline">\(t\)</span>.</p>
<p>TD(0) replaces <span class="math inline">\(G_t\)</span> by the immediate return and the currant estimate <span id="eq-td-update-one-step"><span class="math display">\[
V(S_t) \gets V(S_t) + \alpha [\underbrace{R_{t+1} + \gamma V(S_{t+1}) - V(S_t)}_\text{TD error}]
\tag{6.2}\]</span></span> the TD error for time <span class="math inline">\(t\)</span> is denoted by <span class="math inline">\(\delta_t\)</span> <span id="eq-def-td-error"><span class="math display">\[
\delta_t := R_{t+1} + \gamma V(S_{t+1}) - V(S_t)
\tag{6.3}\]</span></span></p>
<p>Here is the complete algorithm</p>
<div id="lst-mc-prediction-first-visit" class="listing-block listing quarto-float quarto-figure quarto-figure-left anchored">
<figure class="quarto-float quarto-float-lst figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-lst" id="lst-mc-prediction-first-visit-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Listing&nbsp;6.1: Tabular TD(0) for estimating <span class="math inline">\(v_{\pi}\)</span>
</figcaption>
<div aria-describedby="lst-mc-prediction-first-visit-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="line-block"><strong>Input</strong>: <span class="math inline">\(\pi\)</span>, the policy to be evaluated<br>
<strong>Algorithm parameter</strong>: step-size <span class="math inline">\(\alpha \in (0,1]\)</span><br>
<strong>Initialisation</strong>: <span class="math inline">\(V(s)\)</span>, for all <span class="math inline">\(s \in \mathcal{S}^+\)</span> arbitrarily and <span class="math inline">\(V(\mathrm{terminal}) = 0\)</span><br>
Loop forever:<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="math inline">\(S \gets\)</span> starting state from new episode<br>
&nbsp;&nbsp;&nbsp;&nbsp;Loop until <span class="math inline">\(S\)</span> is terminal:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="math inline">\(A \gets\)</span> action given by <span class="math inline">\(\pi\)</span> for <span class="math inline">\(S\)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Take action <span class="math inline">\(A\)</span>, observe <span class="math inline">\(R,S'\)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="math inline">\(V(S) \gets V(S) + \alpha [R + \gamma V(S') - V(S)]\)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="math inline">\(S \gets S'\)</span></div>
</div>
</figure>
</div>
<p>The algorithm is an <em>on-line</em> version of TD(0). It updates the value function after every step in the episode.</p>
<p>The <em>off-line</em> version of TD(0), updates the value function <span class="math inline">\(V\)</span> at the end of an episode and this <span class="math inline">\(V\)</span> is constant for the TD errors over an episode. This is more similar to the Monte Carlo update regime which updates <span class="math inline">\(V\)</span> at the end of the episode and we can write the MC error in terms of TD errors in the offline case: <span id="eq-mc-error-as-td-errors"><span class="math display">\[
\begin{split}
G_t - V(S_t) &amp;= R_{t+1} + \gamma G_{t+1} - V(S_t) + \gamma V(S_{t+1}) - \gamma V(S_{t+1}) \\
&amp;= \delta_t + \gamma (G_{t+1}-V(S_{t+1})) \\
&amp;= \delta_t + \gamma \delta_{t+1} + \gamma^2 \delta_{t+2} + \dots \gamma^{T-t}(G_T - V(S_T)) \\
&amp;= \sum_{k=t}^{T-1} \gamma^{k-t}\delta_k
\end{split}
\tag{6.4}\]</span></span></p>
<div id="exr-6.1" class="theorem exercise">
<p><span class="theorem-title"><strong>Exercise 6.1</strong></span> If <span class="math inline">\(V\)</span> changes during the episode, then <a href="#eq-mc-error-as-td-errors" class="quarto-xref">Equation&nbsp;<span>6.4</span></a> only holds approximately; what would the difference be between the two sides? Let <span class="math inline">\(V_t\)</span> denote the array of state values used at time <span class="math inline">\(t\)</span> in the TD error <a href="#eq-def-td-error" class="quarto-xref">Equation&nbsp;<span>6.3</span></a> and in the TD update <a href="#eq-td-update-one-step" class="quarto-xref">Equation&nbsp;<span>6.2</span></a>. Redo the derivation above to determine the additional amount that must be added to the sum of TD errors in order to equal the Monte Carlo error.</p>
</div>
<div id="sol-6.1" class="proof solution">
<p><span class="proof-title"><em>Solution 6.1</em>. </span>Let <span class="math display">\[
V_{t+1}(S_t) \gets V_t(S_t) + \alpha[R_{t+1} + \gamma V_{t}(S_{t+1}) - V_t(S_t)]
\]</span> be the per step update rule with TD error <span class="math display">\[
\delta_t = R_{t+1} + \gamma V_{t}(S_{t+1}) - V_t(S_t)
\]</span> for the on-line TD(0) algorithm.</p>
<p>We can expand the Monte Carlo error as follows: <span class="math display">\[
\begin{split}
G_t - V_t(S_t) &amp;= R_{t+1} + \gamma G_{t+1} - V_t(S_t) + \gamma V_t(S_{t+1}) - \gamma V_t(S_{t+1}) \\
&amp;= \delta_t + \gamma(G_{t+1} - V_t(S_{t+1})) \\
&amp;= \delta_t +  \gamma (V_{t+1}(S_{t+1}) - V_t(S_{t+1})) + \gamma(G_{t+1} - V_{t+1}(S_{t+1}))
\end{split}
\]</span> Iterating this as above for the static case gives <span class="math display">\[
G_t - V_t(S_t) = \sum_{k=t}^{T-1}\gamma^{k-t}\delta_k + \sum_{k=t}^{T-1}\gamma^{k-t+1} (V_{t+1}(S_{t+1}) - V_t(S_{t+1})).
\]</span> A quick pedantic note, the last summand in the correction term is always zero, as <span class="math inline">\(V_k(S_T) = 0\)</span> for all <span class="math inline">\(k\)</span> by definition.</p>
<p>So far we have only used the definition of the TD error as above. We can simplify the correction term by using if we use the update rule. It states that from <span class="math inline">\(V_k\)</span> to <span class="math inline">\(V_{k+1}\)</span> only <span class="math inline">\(S_k\)</span> changes, i.e., <span class="math inline">\(V_k(s) = V_{k+1}(s)\)</span> if <span class="math inline">\(s \neq S_k\)</span>. In particular <span class="math inline">\(V_k(S_{k+1}) - V_{k+1}(S_{k+1}) = 0\)</span> if <span class="math inline">\(S_k \neq S_{k+1}\)</span> and also <span class="math display">\[
\begin{split}
V_{k+1}(S_{k}) - V_k(S_{k}) = \alpha \delta_k
\end{split}
\]</span></p>
<p>With this we get <span class="math display">\[
G_t - V_t(S_t) = \sum_{k=t}^{T-1}\gamma^{k-t}\delta_k + \alpha \sum_{k=t}^{T-1}\gamma^{k-t+1} \mathbf{1}[S_{k+1} = S_k]\delta_k.
\]</span></p>
</div>
<div id="exm-6.1" class="theorem example">
<p><span class="theorem-title"><strong>Example 6.1</strong></span> <strong>Driving Home</strong> <span class="citation" data-cites="sutton2018">(<a href="#ref-sutton2018" role="doc-biblioref">Sutton and Barto 2018</a>, Example 6.1)</span></p>
<p>This is a placeholder for the driving home example.</p>
</div>
<div id="exr-6.2" class="theorem exercise">
<p><span class="theorem-title"><strong>Exercise 6.2</strong></span> This is an exercise to help develop your intuition about why TD methods are often more efficient than Monte Carlo methods. Consider the driving home example and how it is addressed by TD and Monte Carlo methods. Can you imagine a scenario in which a TD update would be better on average than a Monte Carlo update? Give an example scenarioâ€”a description of past experience and a current stateâ€”in which you would expect the TD update to be better. Hereâ€™s a hint: Suppose you have lots of experience driving home from work. Then you move to a new building and a new parking lot (but you still enter the highway at the same place). Now you are starting to learn predictions for the new building. Can you see why TD updates are likely to be much better, at least initially, in this case? Might the same sort of thing happen in the original scenario?</p>
</div>
<div id="sol-6.2" class="proof solution">
<p><span class="proof-title"><em>Solution 6.2</em>. </span>Sheesh, another â€˜no clear answersâ€™ exercise. I fear those the most.</p>
<p>Letâ€™s go and take their hint.</p>
<p>Letâ€™s say everything until â€˜exiting highwayâ€™ stays the same. Now, while the values for the rest of the journey might fluctuate a lot (trying out new routes, getting to know the streets) in TD(O) these changes donâ€™t affect everything before exciting highway.</p>
<p>But this has to become a better example still</p>
</div>
</section>
<section id="advantages-of-td-prediction-models" class="level2" data-number="6.2">
<h2 data-number="6.2" class="anchored" data-anchor-id="advantages-of-td-prediction-models"><span class="header-section-number">6.2</span> Advantages of TD Prediction Models</h2>
<div id="exm-6.2" class="theorem example">
<p><span class="theorem-title"><strong>Example 6.2</strong></span> <strong>Random Walk</strong> <span class="citation" data-cites="sutton2018">(<a href="#ref-sutton2018" role="doc-biblioref">Sutton and Barto 2018</a>, Example 6.2)</span></p>
<p>Letâ€™s compare Temporal Difference (TD) learning and Monte Carlo (MC) methods using a simple Markov Reward Process (MRP). The MRP consists of five non-terminal states, <span class="math inline">\(1, \dots, 5\)</span> and two the terminal state <span class="math inline">\(0\)</span> and <span class="math inline">\(6\)</span>â€‹.<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> In this MRP, each state <span class="math inline">\(i\)</span>â€‹ transitions to the adjacent states <span class="math inline">\(iâˆ’1\)</span>â€‹ and <span class="math inline">\(i+1\)</span>â€‹ with a probability of <span class="math inline">\(0.5\)</span> each. All rewards are <span class="math inline">\(0\)</span>, except the transition from <span class="math inline">\(5\)</span> to <span class="math inline">\(6\)</span>â€‹, which yields a reward of 1. This setup is illustrated in the following diagram:</p>
<div class="text-center">
<img src="06-temporal-difference-learning_files/mediabag/426467a63dca99e2f3d5e67b53cbe43fb56a6e15.svg" class="img-fluid">
</div>
<p><br></p>
<p>With this setup the true value <span class="math inline">\(v^*(i)\)</span> of a state is equal to the probability that a random walk starting at this state exits via the right side, and this turns out to be exactly <span class="math inline">\(v^*(i) = i/6\)</span>.</p>
<section id="simplified-update-rule" class="level5 unnumbered">
<h5 class="unnumbered anchored" data-anchor-id="simplified-update-rule">Simplified Update Rule</h5>
<p>We can simplify the update rules for every-visit MC and TD(0) and get rid of the rewards by incorporating them into the values of the terminal states. We require for any value function to have <span class="math inline">\(V(0) = 0\)</span> and <span class="math inline">\(V(6) = 1\)</span>. Then the MC update (<a href="#eq-mc-update-every-visit" class="quarto-xref">Equation&nbsp;<span>6.1</span></a>) becomes <span class="math display">\[
V(S_t) \gets V(S_t) + \alpha (V(S_T) - V(S_t))
\]</span> and the TD(0) (<a href="#eq-td-update-one-step" class="quarto-xref">Equation&nbsp;<span>6.2</span></a>) update becomes <span class="math display">\[
V(S_t) \gets V(S_t) + \alpha [V(S_{t+1}) - V(S_t)]
\]</span> all for <span class="math inline">\(t &lt; T\)</span>.</p>
<p>This is implemented in the code below</p>
<div id="20d04f03" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># === update rules for mc and td ===</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> mc_every_visit_update(episode: <span class="bu">list</span>[<span class="bu">int</span>], V: <span class="bu">list</span>[<span class="bu">float</span>], Î±):</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> s <span class="kw">in</span> episode:</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>        V[s] <span class="op">+=</span> Î± <span class="op">*</span> (V[episode[<span class="op">-</span><span class="dv">1</span>]] <span class="op">-</span> V[s])</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> one_step_td_update(episode: <span class="bu">list</span>[<span class="bu">int</span>], V: <span class="bu">list</span>[<span class="bu">float</span>], Î±):</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> s, s_next <span class="kw">in</span> <span class="bu">zip</span>(episode[:<span class="op">-</span><span class="dv">1</span>], episode[<span class="dv">1</span>:]):</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>        V[s] <span class="op">+=</span> Î± <span class="op">*</span> (V[s_next] <span class="op">-</span> V[s])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Letâ€™s see what kind of learning behaviour this results for DT in a concrete example. Let us generate a couple of episodesâ€¦</p>
<div id="3214915b" class="cell" data-execution_count="3">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># === generate bunch of random walk episodes ===</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> random</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="co"># data generation</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> generate_random_walk_episode(env_size, rng):</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    midpoint <span class="op">=</span> (env_size <span class="op">+</span> <span class="dv">1</span>) <span class="op">//</span> <span class="dv">2</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>    state <span class="op">=</span> midpoint</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>    states <span class="op">=</span> [state]</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="dv">0</span> <span class="op">&lt;</span> state <span class="op">&lt;</span> (env_size <span class="op">+</span> <span class="dv">1</span>):</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>        direction <span class="op">=</span> <span class="dv">1</span> <span class="cf">if</span> rng.random() <span class="op">&lt;</span> <span class="fl">0.5</span> <span class="cf">else</span> <span class="op">-</span><span class="dv">1</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>        state <span class="op">=</span> state <span class="op">+</span> direction</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>        states.append(state)</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> states</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> generate_random_walk_dataset(n_episodes, batch_size, rng<span class="op">=</span><span class="va">None</span>, env_size<span class="op">=</span><span class="dv">5</span>):</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> rng <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>        rng <span class="op">=</span> random.Random()</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>    dataset <span class="op">=</span> []</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(n_episodes):</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>        episode_batch <span class="op">=</span> [</span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>            generate_random_walk_episode(env_size, rng) <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(batch_size)</span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>        dataset.append(episode_batch)</span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> dataset</span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>rng <span class="op">=</span> random.Random(<span class="dv">5</span>)</span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>random_walk_batches <span class="op">=</span> generate_random_walk_dataset(</span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>    env_size<span class="op">=</span><span class="dv">5</span>, n_episodes<span class="op">=</span><span class="dv">100</span>, batch_size<span class="op">=</span><span class="dv">1</span>, rng<span class="op">=</span>rng</span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Generated </span><span class="sc">{</span><span class="bu">len</span>(random_walk_batches)<span class="sc">}</span><span class="ss"> random walk episodes!"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Generated 100 random walk episodes!</code></pre>
</div>
</div>
<p>â€¦ and see how the initial estimate of <span class="math inline">\(V(i) = 0.5\)</span> evolves over time using this update rule.</p>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> math</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="co"># helpers</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_estimates_history(episode_batches, init_V, update_fun, Î±):</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    batch_size <span class="op">=</span> <span class="bu">len</span>(episode_batches[<span class="dv">0</span>])</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>    batch_V <span class="op">=</span> np.array([init_V.copy() <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(batch_size)])</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> mean():</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> np.mean(batch_V, axis<span class="op">=</span><span class="dv">0</span>)[<span class="dv">1</span>:<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> std_err():</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> np.std(batch_V, axis<span class="op">=</span><span class="dv">0</span>)[<span class="dv">1</span>:<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>    estimates_history <span class="op">=</span> [(mean(), std_err())]</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> episode_batch <span class="kw">in</span> episode_batches:</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i, episode <span class="kw">in</span> <span class="bu">enumerate</span>(episode_batch):</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>            update_fun(episode, batch_V[i], Î±<span class="op">=</span>Î±)</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>        estimates_history.append((mean(), std_err()))</span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> estimates_history</span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_true_values(env_size):</span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> [i <span class="op">/</span> (env_size <span class="op">+</span> <span class="dv">1</span>) <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">0</span>, env_size <span class="op">+</span> <span class="dv">2</span>)]</span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_estimates_history(</span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>    estimates_history,</span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>    runs_to_plot,</span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>    confidence_bands<span class="op">=</span>[],</span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a>    title<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a>    err_factor<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a>    env_size <span class="op">=</span> <span class="bu">len</span>(estimates_history[<span class="dv">0</span>][<span class="dv">0</span>])</span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> <span class="bu">range</span>(<span class="dv">1</span>, env_size <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create a figure and axis</span></span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a>    fig, ax <span class="op">=</span> plt.subplots()</span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot each run</span></span>
<span id="cb4-45"><a href="#cb4-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-46"><a href="#cb4-46" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> run <span class="kw">in</span> runs_to_plot:</span>
<span id="cb4-47"><a href="#cb4-47" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> run <span class="op">&lt;</span> <span class="bu">len</span>(estimates_history):</span>
<span id="cb4-48"><a href="#cb4-48" aria-hidden="true" tabindex="-1"></a>            mean_estimates, std_errs <span class="op">=</span> estimates_history[run]</span>
<span id="cb4-49"><a href="#cb4-49" aria-hidden="true" tabindex="-1"></a>            label <span class="op">=</span> <span class="ss">f"Episode </span><span class="sc">{</span>run<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb4-50"><a href="#cb4-50" aria-hidden="true" tabindex="-1"></a>            (line,) <span class="op">=</span> ax.plot(</span>
<span id="cb4-51"><a href="#cb4-51" aria-hidden="true" tabindex="-1"></a>                x,</span>
<span id="cb4-52"><a href="#cb4-52" aria-hidden="true" tabindex="-1"></a>                mean_estimates,</span>
<span id="cb4-53"><a href="#cb4-53" aria-hidden="true" tabindex="-1"></a>                marker<span class="op">=</span><span class="st">"o"</span>,</span>
<span id="cb4-54"><a href="#cb4-54" aria-hidden="true" tabindex="-1"></a>                label<span class="op">=</span>label,</span>
<span id="cb4-55"><a href="#cb4-55" aria-hidden="true" tabindex="-1"></a>                zorder<span class="op">=</span><span class="dv">3</span>,</span>
<span id="cb4-56"><a href="#cb4-56" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb4-57"><a href="#cb4-57" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> run <span class="kw">in</span> confidence_bands:</span>
<span id="cb4-58"><a href="#cb4-58" aria-hidden="true" tabindex="-1"></a>                std_errs_ <span class="op">=</span> [err_factor <span class="op">*</span> std_err <span class="cf">for</span> std_err <span class="kw">in</span> std_errs]</span>
<span id="cb4-59"><a href="#cb4-59" aria-hidden="true" tabindex="-1"></a>                ax.fill_between(</span>
<span id="cb4-60"><a href="#cb4-60" aria-hidden="true" tabindex="-1"></a>                    x,</span>
<span id="cb4-61"><a href="#cb4-61" aria-hidden="true" tabindex="-1"></a>                    [m <span class="op">-</span> s <span class="cf">for</span> m, s <span class="kw">in</span> <span class="bu">zip</span>(mean_estimates, std_errs_)],</span>
<span id="cb4-62"><a href="#cb4-62" aria-hidden="true" tabindex="-1"></a>                    [m <span class="op">+</span> s <span class="cf">for</span> m, s <span class="kw">in</span> <span class="bu">zip</span>(mean_estimates, std_errs_)],</span>
<span id="cb4-63"><a href="#cb4-63" aria-hidden="true" tabindex="-1"></a>                    color<span class="op">=</span>line.get_color(),</span>
<span id="cb4-64"><a href="#cb4-64" aria-hidden="true" tabindex="-1"></a>                    alpha<span class="op">=</span><span class="fl">0.2</span>,</span>
<span id="cb4-65"><a href="#cb4-65" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb4-66"><a href="#cb4-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-67"><a href="#cb4-67" aria-hidden="true" tabindex="-1"></a>    ax.set_ylim(<span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb4-68"><a href="#cb4-68" aria-hidden="true" tabindex="-1"></a>    ax.set_xticks(<span class="bu">range</span>(<span class="dv">1</span>, env_size <span class="op">+</span> <span class="dv">1</span>))</span>
<span id="cb4-69"><a href="#cb4-69" aria-hidden="true" tabindex="-1"></a>    ax.set_xlabel(<span class="st">"State"</span>, fontsize<span class="op">=</span><span class="dv">14</span>)</span>
<span id="cb4-70"><a href="#cb4-70" aria-hidden="true" tabindex="-1"></a>    ax.set_ylabel(<span class="st">"Estimated Value"</span>, fontsize<span class="op">=</span><span class="dv">14</span>)</span>
<span id="cb4-71"><a href="#cb4-71" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> title <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb4-72"><a href="#cb4-72" aria-hidden="true" tabindex="-1"></a>        ax.set_title(title)</span>
<span id="cb4-73"><a href="#cb4-73" aria-hidden="true" tabindex="-1"></a>    ax.legend()</span>
<span id="cb4-74"><a href="#cb4-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-75"><a href="#cb4-75" aria-hidden="true" tabindex="-1"></a>    true_values <span class="op">=</span> compute_true_values(env_size)</span>
<span id="cb4-76"><a href="#cb4-76" aria-hidden="true" tabindex="-1"></a>    ax.plot(</span>
<span id="cb4-77"><a href="#cb4-77" aria-hidden="true" tabindex="-1"></a>        x, true_values[<span class="dv">1</span>:<span class="op">-</span><span class="dv">1</span>], label<span class="op">=</span><span class="st">"True values"</span>, alpha<span class="op">=</span><span class="fl">0.5</span>, color<span class="op">=</span><span class="st">"black"</span>, linewidth<span class="op">=</span><span class="dv">1</span></span>
<span id="cb4-78"><a href="#cb4-78" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb4-79"><a href="#cb4-79" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> fig, ax</span>
<span id="cb4-80"><a href="#cb4-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-81"><a href="#cb4-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-82"><a href="#cb4-82" aria-hidden="true" tabindex="-1"></a><span class="co"># create estimates and plot</span></span>
<span id="cb4-83"><a href="#cb4-83" aria-hidden="true" tabindex="-1"></a>env_size <span class="op">=</span> <span class="dv">5</span></span>
<span id="cb4-84"><a href="#cb4-84" aria-hidden="true" tabindex="-1"></a>Î±_mt <span class="op">=</span> <span class="fl">0.1</span></span>
<span id="cb4-85"><a href="#cb4-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-86"><a href="#cb4-86" aria-hidden="true" tabindex="-1"></a>init_estimates <span class="op">=</span> [<span class="fl">0.5</span>] <span class="op">*</span> (env_size <span class="op">+</span> <span class="dv">2</span>)</span>
<span id="cb4-87"><a href="#cb4-87" aria-hidden="true" tabindex="-1"></a>init_estimates[<span class="dv">0</span>] <span class="op">=</span> <span class="fl">0.0</span></span>
<span id="cb4-88"><a href="#cb4-88" aria-hidden="true" tabindex="-1"></a>init_estimates[<span class="op">-</span><span class="dv">1</span>] <span class="op">=</span> <span class="fl">1.0</span></span>
<span id="cb4-89"><a href="#cb4-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-90"><a href="#cb4-90" aria-hidden="true" tabindex="-1"></a>true_values <span class="op">=</span> compute_true_values(env_size)</span>
<span id="cb4-91"><a href="#cb4-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-92"><a href="#cb4-92" aria-hidden="true" tabindex="-1"></a>estimates_history_td <span class="op">=</span> create_estimates_history(</span>
<span id="cb4-93"><a href="#cb4-93" aria-hidden="true" tabindex="-1"></a>    random_walk_batches,</span>
<span id="cb4-94"><a href="#cb4-94" aria-hidden="true" tabindex="-1"></a>    init_estimates,</span>
<span id="cb4-95"><a href="#cb4-95" aria-hidden="true" tabindex="-1"></a>    one_step_td_update,</span>
<span id="cb4-96"><a href="#cb4-96" aria-hidden="true" tabindex="-1"></a>    Î±_mt,</span>
<span id="cb4-97"><a href="#cb4-97" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb4-98"><a href="#cb4-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-99"><a href="#cb4-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-100"><a href="#cb4-100" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plot_estimates_history(</span>
<span id="cb4-101"><a href="#cb4-101" aria-hidden="true" tabindex="-1"></a>    estimates_history_td,</span>
<span id="cb4-102"><a href="#cb4-102" aria-hidden="true" tabindex="-1"></a>    runs_to_plot<span class="op">=</span>[<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">10</span>, <span class="dv">100</span>],</span>
<span id="cb4-103"><a href="#cb4-103" aria-hidden="true" tabindex="-1"></a>    title<span class="op">=</span><span class="ss">f"Estimates development under TD(0)-updates for Î±=</span><span class="sc">{Î±</span>_mt<span class="sc">}</span><span class="ss">"</span>,</span>
<span id="cb4-104"><a href="#cb4-104" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb4-105"><a href="#cb4-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-106"><a href="#cb4-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-107"><a href="#cb4-107" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div id="fig-random-walk-td-example" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-random-walk-td-example-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div id="939407f7" class="cell" data-execution_count="4">
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="06-temporal-difference-learning_files/figure-html/cell-4-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-1" title="Figure&nbsp;6.1: Estimates development under TD(0)-updates. The true values lie on the gray line."><img src="06-temporal-difference-learning_files/figure-html/cell-4-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-random-walk-td-example-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;6.1: Estimates development under TD(0)-updates. The true values lie on the gray line.
</figcaption>
</figure>
</div>
<p>We will discuss <a href="#fig-random-walk-td-example" class="quarto-xref">Figure&nbsp;<span>6.1</span></a> a bit more in an exercise.</p>
<p>Next we compare the performance of every-visit MC and TD(0). We can use the root mean-squared error across states as performance measure:</p>
<p><span class="math display">\[
\mathrm{RSME}(V) = \sqrt{\frac{1}{5}\sum_{i=1}^5 (V(i)- v^*(i))^2}.
\]</span></p>
<p>(This is proportional to the Euclidean distance of the estimate and the true values, and I think RSME is a bit of a misleading name, but here I stick to the source)</p>
<p>The next plot shows the development of the averaged RMSE over time.</p>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># === RMSE comparison for MC and TD(0) ===</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="co"># helper</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> euclid_distance(true_values, estimates) <span class="op">-&gt;</span> <span class="bu">float</span>:</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># exclude terminal state in distance calculation</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>    diffs <span class="op">=</span> (np.array(estimates) <span class="op">-</span> np.array(true_values))[<span class="dv">1</span>:]</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">float</span>(np.sqrt(np.mean(diffs<span class="op">**</span><span class="dv">2</span>)))</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_error_history(</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>    dataset,</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>    init_estimates,</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>    update_fun,</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>    true_values,</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>    Î±<span class="op">=</span><span class="fl">0.1</span>,</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> <span class="bu">list</span>[<span class="bu">float</span>]:</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>    n_runs <span class="op">=</span> <span class="bu">len</span>(dataset[<span class="dv">0</span>])</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>    estimates_batch <span class="op">=</span> [init_estimates.copy() <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(n_runs)]</span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> mean_distance() <span class="op">-&gt;</span> <span class="bu">float</span>:</span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">float</span>(</span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>            np.mean([euclid_distance(true_values, v) <span class="cf">for</span> v <span class="kw">in</span> estimates_batch])</span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>    rms_history: List[<span class="bu">float</span>] <span class="op">=</span> [mean_distance()]</span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> episode_batch <span class="kw">in</span> dataset:</span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> run_idx, episode <span class="kw">in</span> <span class="bu">enumerate</span>(episode_batch):</span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a>            update_fun(episode, estimates_batch[run_idx], Î±<span class="op">=</span>Î±)</span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>        rms_history.append(mean_distance())</span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> rms_history</span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a><span class="co"># data generation and plot</span></span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a>batch_size <span class="op">=</span> <span class="dv">100</span></span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a>n_episodes <span class="op">=</span> <span class="dv">100</span></span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a>rng <span class="op">=</span> random.Random(<span class="dv">0</span>)  <span class="co"># reproducible data</span></span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-42"><a href="#cb5-42" aria-hidden="true" tabindex="-1"></a>dataset <span class="op">=</span> generate_random_walk_dataset(</span>
<span id="cb5-43"><a href="#cb5-43" aria-hidden="true" tabindex="-1"></a>    n_episodes<span class="op">=</span>n_episodes, batch_size<span class="op">=</span>batch_size, rng<span class="op">=</span>rng</span>
<span id="cb5-44"><a href="#cb5-44" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb5-45"><a href="#cb5-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-46"><a href="#cb5-46" aria-hidden="true" tabindex="-1"></a>alphas_td <span class="op">=</span> [<span class="fl">0.15</span>, <span class="fl">0.1</span>, <span class="fl">0.04</span>]</span>
<span id="cb5-47"><a href="#cb5-47" aria-hidden="true" tabindex="-1"></a>alphas_mc <span class="op">=</span> [<span class="fl">0.01</span>, <span class="fl">0.03</span>]</span>
<span id="cb5-48"><a href="#cb5-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-49"><a href="#cb5-49" aria-hidden="true" tabindex="-1"></a>lines_td <span class="op">=</span> []</span>
<span id="cb5-50"><a href="#cb5-50" aria-hidden="true" tabindex="-1"></a>lines_mc <span class="op">=</span> []</span>
<span id="cb5-51"><a href="#cb5-51" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> Î± <span class="kw">in</span> alphas_td:</span>
<span id="cb5-52"><a href="#cb5-52" aria-hidden="true" tabindex="-1"></a>    rms <span class="op">=</span> create_error_history(</span>
<span id="cb5-53"><a href="#cb5-53" aria-hidden="true" tabindex="-1"></a>        update_fun<span class="op">=</span>one_step_td_update,</span>
<span id="cb5-54"><a href="#cb5-54" aria-hidden="true" tabindex="-1"></a>        true_values<span class="op">=</span>true_values,</span>
<span id="cb5-55"><a href="#cb5-55" aria-hidden="true" tabindex="-1"></a>        dataset<span class="op">=</span>dataset,</span>
<span id="cb5-56"><a href="#cb5-56" aria-hidden="true" tabindex="-1"></a>        init_estimates<span class="op">=</span>init_estimates,</span>
<span id="cb5-57"><a href="#cb5-57" aria-hidden="true" tabindex="-1"></a>        Î±<span class="op">=</span>Î±,</span>
<span id="cb5-58"><a href="#cb5-58" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb5-59"><a href="#cb5-59" aria-hidden="true" tabindex="-1"></a>    (line,) <span class="op">=</span> plt.plot(rms, label<span class="op">=</span><span class="ss">f"Î±=</span><span class="sc">{Î±}</span><span class="ss">"</span>)</span>
<span id="cb5-60"><a href="#cb5-60" aria-hidden="true" tabindex="-1"></a>    lines_td.append(line)</span>
<span id="cb5-61"><a href="#cb5-61" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> Î± <span class="kw">in</span> alphas_mc:</span>
<span id="cb5-62"><a href="#cb5-62" aria-hidden="true" tabindex="-1"></a>    rms <span class="op">=</span> create_error_history(</span>
<span id="cb5-63"><a href="#cb5-63" aria-hidden="true" tabindex="-1"></a>        update_fun<span class="op">=</span>mc_every_visit_update,</span>
<span id="cb5-64"><a href="#cb5-64" aria-hidden="true" tabindex="-1"></a>        true_values<span class="op">=</span>true_values,</span>
<span id="cb5-65"><a href="#cb5-65" aria-hidden="true" tabindex="-1"></a>        dataset<span class="op">=</span>dataset,</span>
<span id="cb5-66"><a href="#cb5-66" aria-hidden="true" tabindex="-1"></a>        init_estimates<span class="op">=</span>init_estimates,</span>
<span id="cb5-67"><a href="#cb5-67" aria-hidden="true" tabindex="-1"></a>        Î±<span class="op">=</span>Î±,</span>
<span id="cb5-68"><a href="#cb5-68" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb5-69"><a href="#cb5-69" aria-hidden="true" tabindex="-1"></a>    plt.plot(rms, label<span class="op">=</span><span class="ss">f"Î±=</span><span class="sc">{Î±}</span><span class="ss">, mc"</span>, linestyle<span class="op">=</span><span class="st">"--"</span>)</span>
<span id="cb5-70"><a href="#cb5-70" aria-hidden="true" tabindex="-1"></a>    (line,) <span class="op">=</span> plt.plot(rms, label<span class="op">=</span><span class="ss">f"Î±=</span><span class="sc">{Î±}</span><span class="ss">"</span>, linestyle<span class="op">=</span><span class="st">"--"</span>)</span>
<span id="cb5-71"><a href="#cb5-71" aria-hidden="true" tabindex="-1"></a>    lines_mc.append(line)</span>
<span id="cb5-72"><a href="#cb5-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-73"><a href="#cb5-73" aria-hidden="true" tabindex="-1"></a><span class="co"># Create legends for TD and MC separately</span></span>
<span id="cb5-74"><a href="#cb5-74" aria-hidden="true" tabindex="-1"></a>td_legend <span class="op">=</span> plt.legend(</span>
<span id="cb5-75"><a href="#cb5-75" aria-hidden="true" tabindex="-1"></a>    handles<span class="op">=</span>lines_td,</span>
<span id="cb5-76"><a href="#cb5-76" aria-hidden="true" tabindex="-1"></a>    labels<span class="op">=</span>[<span class="ss">f"Î±=</span><span class="sc">{Î±}</span><span class="ss">"</span> <span class="cf">for</span> Î± <span class="kw">in</span> alphas_td],</span>
<span id="cb5-77"><a href="#cb5-77" aria-hidden="true" tabindex="-1"></a>    title<span class="op">=</span><span class="st">"TD(0)"</span>,</span>
<span id="cb5-78"><a href="#cb5-78" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb5-79"><a href="#cb5-79" aria-hidden="true" tabindex="-1"></a>plt.gca().add_artist(td_legend)</span>
<span id="cb5-80"><a href="#cb5-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-81"><a href="#cb5-81" aria-hidden="true" tabindex="-1"></a>mc_legend <span class="op">=</span> plt.legend(</span>
<span id="cb5-82"><a href="#cb5-82" aria-hidden="true" tabindex="-1"></a>    handles<span class="op">=</span>lines_mc,</span>
<span id="cb5-83"><a href="#cb5-83" aria-hidden="true" tabindex="-1"></a>    labels<span class="op">=</span>[<span class="ss">f"Î±=</span><span class="sc">{Î±}</span><span class="ss">"</span> <span class="cf">for</span> Î± <span class="kw">in</span> alphas_mc],</span>
<span id="cb5-84"><a href="#cb5-84" aria-hidden="true" tabindex="-1"></a>    title<span class="op">=</span><span class="st">"ev. MC"</span>,</span>
<span id="cb5-85"><a href="#cb5-85" aria-hidden="true" tabindex="-1"></a>    bbox_to_anchor<span class="op">=</span>(<span class="fl">1.0</span>, <span class="fl">0.75</span>),</span>
<span id="cb5-86"><a href="#cb5-86" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb5-87"><a href="#cb5-87" aria-hidden="true" tabindex="-1"></a>plt.gca().add_artist(mc_legend)</span>
<span id="cb5-88"><a href="#cb5-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-89"><a href="#cb5-89" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Episodes"</span>)</span>
<span id="cb5-90"><a href="#cb5-90" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Mean RMSE"</span>)</span>
<span id="cb5-91"><a href="#cb5-91" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="ss">f"RMSE Comparison (averaged over </span><span class="sc">{</span>batch_size<span class="sc">}</span><span class="ss"> runs)"</span>)</span>
<span id="cb5-92"><a href="#cb5-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-93"><a href="#cb5-93" aria-hidden="true" tabindex="-1"></a>plt.grid(<span class="va">True</span>)</span>
<span id="cb5-94"><a href="#cb5-94" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div id="fig-random-walk-rmse-for-td-and-mc" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-random-walk-rmse-for-td-and-mc-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div id="dfd282e9" class="cell" data-execution_count="5">
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="06-temporal-difference-learning_files/figure-html/cell-5-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-2" title="Figure&nbsp;6.2: Comparison between every visit MC and TD(0) for different values of \alpha. Performance is measured by RMSE across the states."><img src="06-temporal-difference-learning_files/figure-html/cell-5-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-random-walk-rmse-for-td-and-mc-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;6.2: Comparison between every visit MC and TD(0) for different values of <span class="math inline">\(\alpha\)</span>. Performance is measured by RMSE across the states.
</figcaption>
</figure>
</div>
<p>Since TD(0) and every-visit MC have different speeds in how they update their estimates, we need to compare them using different ranges of the learning rate in <a href="#fig-random-walk-rmse-for-td-and-mc" class="quarto-xref">Figure&nbsp;<span>6.2</span></a>. Still, we can see that TD performs better: it has a better mix between fast convergence and asymptoticâ€”if we choose the best step-size parameters such that TD and MC approach the same asymptotic performance, TD gets there faster.</p>
<p>Letâ€™s analyse the two approaches in another way, to see how their bias and variance behaves. We show the average estimates and their standard deviations per state for both TD and MC for 100 with update-rates such that they have basically stopped improving around the 100 episode mark (i.e.&nbsp;their at their asymptotic performance).</p>
<div id="fig-mc_vs_td" class="quarto-layout-panel">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-mc_vs_td-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row">
<div class="quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-mc_vs_td" style="flex-basis: 50.0%;justify-content: flex-start;">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># === td history ===</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>rng <span class="op">=</span> random.Random(<span class="dv">7</span>)</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>env_size <span class="op">=</span> <span class="dv">5</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>batch_size <span class="op">=</span> <span class="dv">200</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>random_walk_batches <span class="op">=</span> generate_random_walk_dataset(</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>    env_size<span class="op">=</span>env_size, n_episodes<span class="op">=</span><span class="dv">100</span>, batch_size<span class="op">=</span>batch_size, rng<span class="op">=</span>rng</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>Î±_td <span class="op">=</span> <span class="fl">0.07</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>estimates_history_td <span class="op">=</span> create_estimates_history(</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>    random_walk_batches,</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>    init_estimates,</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>    one_step_td_update,</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>    Î±_td,</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>err_factor <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plot_estimates_history(</span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>    estimates_history_td,</span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>    runs_to_plot<span class="op">=</span>[<span class="dv">0</span>, <span class="dv">15</span>, <span class="dv">30</span>, <span class="dv">50</span>, <span class="dv">100</span>],</span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>    confidence_bands<span class="op">=</span>[<span class="dv">15</span>, <span class="dv">100</span>],</span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>    title<span class="op">=</span><span class="ss">f"TD Î±=</span><span class="sc">{Î±</span>_td<span class="sc">}</span><span class="ss"> (averaged over </span><span class="sc">{</span>batch_size<span class="sc">}</span><span class="ss"> runs)"</span>,</span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>    err_factor<span class="op">=</span>err_factor,</span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div id="fig-mc_vs_td-a" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-mc_vs_td-a-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div id="5a8f5a3c" class="cell" data-execution_count="6">
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="06-temporal-difference-learning_files/figure-html/cell-6-output-1.png" class="lightbox" data-gallery="fig-mc_vs_td" title="Figure&nbsp;6.3&nbsp;(a): One-step TD."><img src="06-temporal-difference-learning_files/figure-html/cell-6-output-1.png" class="img-fluid figure-img" data-ref-parent="fig-mc_vs_td"></a></p>
</figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-mc_vs_td-a-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a) One-step TD.
</figcaption>
</figure>
</div>
</div>
<div class="quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-mc_vs_td" style="flex-basis: 50.0%;justify-content: flex-start;">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>Î±_mc <span class="op">=</span> <span class="fl">0.04</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="co"># === mc history ===</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>estimates_history_mc <span class="op">=</span> create_estimates_history(</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    random_walk_batches,</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    init_estimates,</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>    mc_every_visit_update,</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>    Î±_mc,</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plot_estimates_history(</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>    estimates_history_mc,</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>    runs_to_plot<span class="op">=</span>[<span class="dv">0</span>, <span class="dv">15</span>, <span class="dv">30</span>, <span class="dv">50</span>, <span class="dv">100</span>],</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>    confidence_bands<span class="op">=</span>[<span class="dv">15</span>, <span class="dv">100</span>],</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>    title<span class="op">=</span><span class="ss">f"MC Î±=</span><span class="sc">{Î±</span>_mc<span class="sc">}</span><span class="ss"> (averaged over </span><span class="sc">{</span>batch_size<span class="sc">}</span><span class="ss"> runs)"</span>,</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>    err_factor<span class="op">=</span>err_factor,</span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div id="fig-mc_vs_td-b" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-mc_vs_td-b-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div id="963020f5" class="cell" data-execution_count="7">
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="06-temporal-difference-learning_files/figure-html/cell-7-output-1.png" class="lightbox" data-gallery="fig-mc_vs_td" title="Figure&nbsp;6.3&nbsp;(b): MC every visit"><img src="06-temporal-difference-learning_files/figure-html/cell-7-output-1.png" class="img-fluid figure-img" data-ref-parent="fig-mc_vs_td"></a></p>
</figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-mc_vs_td-b-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b) MC every visit
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-mc_vs_td-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;6.3: Comparison of every-visit MC and TD(0) averaged. The learning rates are chosen such that for both there are no changes in expectation after more than 100 episodes, i.e., the means are stable for episodes 100. For the Episode counts 15 and 100 we show the confidence bands for the estimates.
</figcaption>
</figure>
</div>
<p>The three biggest insights from <a href="#fig-mc_vs_td" class="quarto-xref">Figure&nbsp;<span>6.3</span></a> are:</p>
<ul>
<li>every-visit MC converges faster to the true values in expectation</li>
<li>TD(0) has much lower standard error</li>
<li>in fact, TD(0) doesnâ€™t converge to the true values in expectation! It has an asymptotic bias.</li>
</ul>
</section>
</div>
<div id="exr-6.3" class="theorem exercise">
<p><span class="theorem-title"><strong>Exercise 6.3</strong></span> From the results shown in <a href="#fig-random-walk-td-example" class="quarto-xref">Figure&nbsp;<span>6.1</span></a> of the random walk example it appears that the first episode results in a change in only <span class="math inline">\(V(n_1)\)</span><a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a>. What does this tell you about what happened on the first episode? Why was only the estimate for this one state changed? By exactly how much was it changed?</p>
</div>
<div id="sol-6.3" class="proof solution">
<p><span class="proof-title"><em>Solution 6.3</em>. </span>The errors in the TD updates are <span class="math inline">\(V(S_{t+1} - V(S_t))\)</span> for all <span class="math inline">\(t &lt; T\)</span>. Since in the initial estimate all states have the same estimated value, these all vanish for <span class="math inline">\(t &lt; T-1\)</span>.</p>
<p>The last TD error for <span class="math inline">\(t = T-1\)</span> is <span class="math inline">\([V(S_T) - V(S_{T-1})]\)</span>. We can see that <span class="math inline">\(1\)</span> got updated so the episode excited on the left thus <span class="math inline">\(S_T = 0\)</span>. This makes the error <span class="math inline">\([0 - 0.5] = -0.5\)</span> and the update is <span class="math inline">\(\alpha \cdot (-0.5) = 0.1 \cdot (-0.5) = -0.05\)</span>.</p>
</div>
<div id="exr-6.4" class="theorem exercise">
<p><span class="theorem-title"><strong>Exercise 6.4</strong></span> The specific results shown <a href="#fig-random-walk-rmse-for-td-and-mc" class="quarto-xref">Figure&nbsp;<span>6.2</span></a> of the random walk example are dependent on the value of the step-size parameter, <span class="math inline">\(\alpha\)</span>. Do you think the conclusions about which algorithm is better would be affected if a wider range of <span class="math inline">\(\alpha\)</span> values were used? Is there a different, fixed value of <span class="math inline">\(\alpha\)</span> at which either algorithm would have performed significantly better than shown? Why or why not?</p>
</div>
<div id="sol-6.4" class="proof solution">
<p><span class="proof-title"><em>Solution 6.4</em>. </span>No, the conclusion is that TD gets faster to its asymptotic is independent of the step-size.</p>
<p>The answer to the second questions depends on what is meant by better? The best step-size depends on what we want, how fast or how accurate, which are in conflict with each other. So basically any reasonable <span class="math inline">\(\alpha\)</span> is optimal for some scenario.</p>
</div>
<div id="exr-6.5" class="theorem exercise">
<p><span class="theorem-title"><strong>Exercise 6.5</strong></span> In <a href="#fig-random-walk-rmse-for-td-and-mc" class="quarto-xref">Figure&nbsp;<span>6.2</span></a> of the random walk example, the RMS error of the TD method seems to go down and then up again, particularly at high <span class="math inline">\(\alpha\)</span>â€™s. What could have caused this? Do you think this always occurs, or might it be a function of how the approximate value function was initialized?</p>
</div>
<div id="sol-6.5" class="proof solution">
<p><span class="proof-title"><em>Solution 6.5</em>. </span>Interesting question. I think the underlying answer to this question is, that the TD(0) method is asymptotically biased, which we will discuss now.</p>
<section id="moving-towards-the-asymptotic-bias" class="level5 unnumbered">
<h5 class="unnumbered anchored" data-anchor-id="moving-towards-the-asymptotic-bias">Moving towards the asymptotic bias</h5>
<p>In <a href="#fig-random-walk-rmse-for-td-and-mc" class="quarto-xref">Figure&nbsp;<span>6.2</span></a> we can see for <span class="math inline">\(\alpha = 0.15\)</span> quite a visible dip with itâ€™s lowest point around 20 and at 60 the performance looks stable. Letâ€™s see how the average estimates look like over this time period.</p>
<div id="53a8c571" class="cell" data-execution_count="8">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>rng <span class="op">=</span> random.Random(<span class="dv">0</span>)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>env_size <span class="op">=</span> <span class="dv">5</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>Î±_exr_6_5 <span class="op">=</span> <span class="fl">0.15</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>bs_exr_6_5 <span class="op">=</span> <span class="dv">400</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>random_walks_exr_6_5 <span class="op">=</span> generate_random_walk_dataset(</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>    env_size<span class="op">=</span>env_size, n_episodes<span class="op">=</span><span class="dv">200</span>, batch_size<span class="op">=</span>bs_exr_6_5, rng<span class="op">=</span>rng</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>estimates_standard_exr_6_5 <span class="op">=</span> create_estimates_history(</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>    random_walks_exr_6_5,</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>    init_estimates,</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>    one_step_td_update,</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>    Î±_exr_6_5,</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>plot_runs <span class="op">=</span> [<span class="dv">0</span>, <span class="dv">10</span>, <span class="dv">20</span>, <span class="dv">60</span>]</span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>err_factor <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plot_estimates_history(</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>    estimates_standard_exr_6_5,</span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>    runs_to_plot<span class="op">=</span>plot_runs,</span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>    title<span class="op">=</span><span class="ss">f"TD(0) Estimates (Î±=</span><span class="sc">{Î±</span>_exr_6_5<span class="sc">}</span><span class="ss">, </span><span class="sc">{</span>bs_exr_6_5<span class="sc">}</span><span class="ss"> runs)"</span>,</span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="06-temporal-difference-learning_files/figure-html/cell-8-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-5"><img src="06-temporal-difference-learning_files/figure-html/cell-8-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>We can see that the estimates slowly approach the gray line, the true values. At episode 20 they are very close but then they go past them and settle at the estimates given at episode 60. So this gives the dip.This asymptotic bias shrinks when <span class="math inline">\(\alpha\)</span> is smaller, so it is less visible, but the effect is still there.</p>
</section>
<section id="approching-the-asymptotic-bias-from-the-other-side" class="level5 unnumbered">
<h5 class="unnumbered anchored" data-anchor-id="approching-the-asymptotic-bias-from-the-other-side">Approching the asymptotic bias from the other side</h5>
<p>If we use initial estimates that start from the â€˜other sideâ€™ so the estimates donâ€™t have to go â€˜throughâ€™ the true values to reach their asymptotic bias, the dip in rmse performance should disappear.</p>
<p>Indeed, if we start with â€˜extremeâ€™ initial estimates</p>
<div id="13a18d3e" class="cell" data-execution_count="9">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>init_extremes <span class="op">=</span> [<span class="dv">0</span>] <span class="op">*</span> <span class="dv">3</span> <span class="op">+</span> [<span class="fl">0.5</span>] <span class="op">+</span> [<span class="dv">1</span>] <span class="op">*</span> <span class="dv">3</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"The extreme iniital estimates: </span><span class="sc">{</span>init_extremes<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>The extreme iniital estimates: [0, 0, 0, 0.5, 1, 1, 1]</code></pre>
</div>
</div>
<p>and compare it with the ordinary estimates we can see that both have the same asymptotic rmse but the extreme initial estimates donâ€™t have the dip.</p>
<div id="fig-sol-6.5-extreme" class="quarto-layout-panel">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-sol-6.5-extreme-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row">
<div class="quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-sol-6.5-extreme" style="flex-basis: 50.0%;justify-content: flex-start;">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>rms_extremes <span class="op">=</span> create_error_history(</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>    update_fun<span class="op">=</span>one_step_td_update,</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    true_values<span class="op">=</span>true_values,</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    dataset<span class="op">=</span>random_walks_exr_6_5,</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    init_estimates<span class="op">=</span>init_extremes,</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>    Î±<span class="op">=</span>Î±_exr_6_5,</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>rms_standard <span class="op">=</span> create_error_history(</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>    update_fun<span class="op">=</span>one_step_td_update,</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>    true_values<span class="op">=</span>true_values,</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>    dataset<span class="op">=</span>random_walks_exr_6_5,</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>    init_estimates<span class="op">=</span>init_estimates,</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>    Î±<span class="op">=</span>Î±_exr_6_5,</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>plt.plot(rms_extremes, label<span class="op">=</span><span class="ss">f"Extreme Initialization"</span>)</span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>plt.plot(rms_standard, label<span class="op">=</span><span class="ss">f"Standard Initialization"</span>)</span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Episodes"</span>)</span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Mean RMSE"</span>)</span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="ss">f"RMSE Comparison (averaged over </span><span class="sc">{</span>bs_exr_6_5<span class="sc">}</span><span class="ss"> runs)"</span>)</span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div id="fig-sol-6.5-extreme-a" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-sol-6.5-extreme-a-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div id="d869bc29" class="cell" data-execution_count="10">
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="06-temporal-difference-learning_files/figure-html/cell-10-output-1.png" class="lightbox" data-gallery="fig-sol-6.5-extreme" title="Figure&nbsp;6.4&nbsp;(a): Comparisson of RMSE for standard and extreme initialization. The extreme initialization doesnâ€™t only improves in performance over time."><img src="06-temporal-difference-learning_files/figure-html/cell-10-output-1.png" class="img-fluid figure-img" data-ref-parent="fig-sol-6.5-extreme"></a></p>
</figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-sol-6.5-extreme-a-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a) Comparisson of RMSE for standard and extreme initialization. The extreme initialization doesnâ€™t only improves in performance over time.
</figcaption>
</figure>
</div>
</div>
<div class="quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-sol-6.5-extreme" style="flex-basis: 50.0%;justify-content: flex-start;">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>init_extremes <span class="op">=</span> [<span class="dv">0</span>] <span class="op">*</span> <span class="dv">3</span> <span class="op">+</span> [<span class="fl">0.5</span>] <span class="op">+</span> [<span class="dv">1</span>] <span class="op">*</span> <span class="dv">3</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>estimates_extreme_exr_6_5 <span class="op">=</span> create_estimates_history(</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>    random_walks_exr_6_5,</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>    init_extremes,</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    one_step_td_update,</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>    Î±_exr_6_5,</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>plot_runs <span class="op">=</span> [<span class="dv">0</span>, <span class="dv">10</span>, <span class="dv">20</span>, <span class="dv">60</span>]</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>err_factor <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plot_estimates_history(</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>    estimates_extreme_exr_6_5,</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>    runs_to_plot<span class="op">=</span>plot_runs,</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>    title<span class="op">=</span><span class="ss">f"TD(0) Estimates (Î±=</span><span class="sc">{Î±</span>_exr_6_5<span class="sc">}</span><span class="ss">, </span><span class="sc">{</span>bs_exr_6_5<span class="sc">}</span><span class="ss"> runs)"</span>,</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div id="fig-sol-6.5-extreme-b" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-sol-6.5-extreme-b-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div id="9a994fca" class="cell" data-execution_count="11">
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="06-temporal-difference-learning_files/figure-html/cell-11-output-1.png" class="lightbox" data-gallery="fig-sol-6.5-extreme" title="Figure&nbsp;6.4&nbsp;(b): The estimates starting from the extreme initialization approach the asymptotic bias from the â€˜other sideâ€™."><img src="06-temporal-difference-learning_files/figure-html/cell-11-output-1.png" class="img-fluid figure-img" data-ref-parent="fig-sol-6.5-extreme"></a></p>
</figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-sol-6.5-extreme-b-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b) The estimates starting from the extreme initialization approach the asymptotic bias from the â€˜other sideâ€™.
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-sol-6.5-extreme-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;6.4: The updates for the extreme initial estimates only improve in rmse performance.
</figcaption>
</figure>
</div>
</section>
<section id="offline-td0-is-consistent" class="level5 unnumbered">
<h5 class="unnumbered anchored" data-anchor-id="offline-td0-is-consistent">Offline TD(0) is consistent</h5>
<p>We have seen that the TD(0) update rule gives an asymptotically biased estimator for fixed <span class="math inline">\(\alpha\)</span>. If we switch from an on-line update to an off-line update, which uses a â€˜frozenâ€™ <span class="math inline">\(V\)</span> in the updates, the estimator becomes consistent, i.e., the asymptotic bias disappears.</p>
<div id="dc9b76aa" class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># === offline TD(0) ===</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> offline_one_step_td_update(episode: <span class="bu">list</span>[<span class="bu">int</span>], V: <span class="bu">list</span>[<span class="bu">float</span>], Î±):</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>    V_frozen <span class="op">=</span> V.copy()</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> s, s_next <span class="kw">in</span> <span class="bu">zip</span>(episode[:<span class="op">-</span><span class="dv">1</span>], episode[<span class="dv">1</span>:]):</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>        V[s] <span class="op">+=</span> Î± <span class="op">*</span> (V_frozen[s_next] <span class="op">-</span> V_frozen[s])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now we can compare offline and online updates.</p>
<div id="fig-sol-6.5-offline" class="quarto-layout-panel">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-sol-6.5-offline-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row">
<div class="quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-sol-6.5-offline" style="flex-basis: 50.0%;justify-content: flex-start;">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>rms_offline <span class="op">=</span> create_error_history(</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>    update_fun<span class="op">=</span>offline_one_step_td_update,</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>    true_values<span class="op">=</span>true_values,</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>    dataset<span class="op">=</span>random_walks_exr_6_5,</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>    init_estimates<span class="op">=</span>init_estimates,</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>    Î±<span class="op">=</span>Î±_exr_6_5,</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>plt.plot(rms_offline, label<span class="op">=</span><span class="ss">f"Offline updates"</span>)</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>plt.plot(rms_standard, label<span class="op">=</span><span class="ss">f"Online updates"</span>)</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Episodes"</span>)</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Mean RMSE"</span>)</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="ss">f"RMSE Comparison (averaged over </span><span class="sc">{</span>bs_exr_6_5<span class="sc">}</span><span class="ss"> runs)"</span>)</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div id="fig-sol-6.5-offline-a" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-sol-6.5-offline-a-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div id="eb2350c8" class="cell" data-execution_count="13">
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="06-temporal-difference-learning_files/figure-html/cell-13-output-1.png" class="lightbox" data-gallery="fig-sol-6.5-offline" title="Figure&nbsp;6.5&nbsp;(a): Off-line and On-line versions of TD(0) with the same initial values and step-size \alpha. The offline version doesnâ€™t show a dip. They seem to have similar performances in the long run for this example."><img src="06-temporal-difference-learning_files/figure-html/cell-13-output-1.png" class="img-fluid figure-img" data-ref-parent="fig-sol-6.5-offline"></a></p>
</figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-sol-6.5-offline-a-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a) Off-line and On-line versions of TD(0) with the same initial values and step-size <span class="math inline">\(\alpha\)</span>. The offline version doesnâ€™t show a dip. They seem to have similar performances in the long run for this example.
</figcaption>
</figure>
</div>
</div>
<div class="quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-sol-6.5-offline" style="flex-basis: 50.0%;justify-content: flex-start;">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>estimates_offline_exr_6_5 <span class="op">=</span> create_estimates_history(</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>    random_walks_exr_6_5,</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>    init_estimates,</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>    offline_one_step_td_update,</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>    Î±_exr_6_5,</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>plot_runs <span class="op">=</span> [<span class="dv">0</span>, <span class="dv">10</span>, <span class="dv">20</span>, <span class="dv">60</span>, <span class="dv">100</span>]</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>err_factor <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plot_estimates_history(</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>    estimates_offline_exr_6_5,</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>    runs_to_plot<span class="op">=</span>plot_runs,</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>    title<span class="op">=</span><span class="ss">f"offline TD(0) Estimates (Î±=</span><span class="sc">{Î±</span>_exr_6_5<span class="sc">}</span><span class="ss">, </span><span class="sc">{</span>bs_exr_6_5<span class="sc">}</span><span class="ss"> runs)"</span>,</span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div id="fig-sol-6.5-offline-b" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-sol-6.5-offline-b-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div id="a487f074" class="cell" data-execution_count="14">
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="06-temporal-difference-learning_files/figure-html/cell-14-output-1.png" class="lightbox" data-gallery="fig-sol-6.5-offline" title="Figure&nbsp;6.5&nbsp;(b): Development of the mean estimates of offline TD(0). The asymptotic means (around episode 100) lie on the true values. So offline TD(0) gives an unbiased estimator."><img src="06-temporal-difference-learning_files/figure-html/cell-14-output-1.png" class="img-fluid figure-img" data-ref-parent="fig-sol-6.5-offline"></a></p>
</figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-sol-6.5-offline-b-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b) Development of the mean estimates of offline TD(0). The asymptotic means (around episode 100) lie on the true values. So offline TD(0) gives an unbiased estimator.
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-sol-6.5-offline-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;6.5: RMSE and mean estimates for offline TD(0).
</figcaption>
</figure>
</div>
<p>So <a href="#fig-sol-6.5-offline" class="quarto-xref">Figure&nbsp;<span>6.5</span></a> shows that offline TD(0) is unbiased. However its performance is not better than than the online version. Actually, in my test online TD(0) was always equally good or even better.</p>
</section>
<section id="why-is-offline-td0-consistent" class="level5 unnumbered">
<h5 class="unnumbered anchored" data-anchor-id="why-is-offline-td0-consistent">Why is offline TD(0) consistent</h5>
<p>So far all results have been purely empirical. Online TD(0) is also not easy to analyse. However, for offline TD(0) we can make a simple argument for why itâ€™s consistent on the random walk example (still a bit shy of a proof).</p>
<p>Let the true value be <span class="math inline">\(V(i)=\frac{i}{6}\)</span>. Fix a state <span class="math inline">\(i\)</span>. For a trajectory <span class="math inline">\(\tau\)</span> let <span class="math inline">\(n_{i\to j}(\tau)\)</span> denote the number of times the transition <span class="math inline">\(i \to j\)</span> occurs in <span class="math inline">\(\tau\)</span>.</p>
<p>The offline TD(0) update to <span class="math inline">\(V(i)\)</span> produced by <span class="math inline">\(\tau\)</span> is <span class="math display">\[
\Delta(\tau) = \alpha(n_{i \to i+1}(\tau)(V(i+1) - V(i)) + n_{i \to i-1}(\tau)(V(i-1) - V(i))).
\]</span> We will show that this is <span class="math inline">\(0\)</span> in expectation, so that <span class="math inline">\(V\)</span> doesnâ€™t change in expectation.</p>
<p>Since transitions to the left and right are equally likely we have <span class="math inline">\(\mathbb{E}[n_{i \to i+1}(\tau)] = \mathbb{E}[n_{i \to i-1}(\tau)] = C\)</span> for some constant <span class="math inline">\(C\)</span>. Thus <span class="math display">\[
\begin{split}
\mathbb{E}_\tau[\Delta(\tau)] &amp;= \alpha C (V(i+1) - V(i)) + C (V(i-1) - V(i)) \\
&amp;= \alpha C (\frac{i+1}{6} - \frac{i}{6} + \frac{i-1}{6} + \frac{i}{6}) = 0
\end{split}
\]</span></p>
</section>
</div>
<div id="exr-6.6" class="theorem exercise">
<p><span class="theorem-title"><strong>Exercise 6.6</strong></span> In <a href="#exm-6.2" class="quarto-xref">Example&nbsp;<span>6.2</span></a> we stated that the true values for the random walk example are <span class="math inline">\(\frac{1}{6}\)</span>, <span class="math inline">\(\frac{2}{6}\)</span>, <span class="math inline">\(\frac{3}{6}\)</span>, <span class="math inline">\(\frac{4}{6}\)</span>, <span class="math inline">\(\frac{5}{6}\)</span>, for states 1 through 5. Describe at least two different ways that these could have been computed. Which would you guess we actually used? Why?</p>
</div>
<div id="sol-6.6" class="proof solution">
<p><span class="proof-title"><em>Solution 6.6</em>. </span>Phew, no idea which method they used and why. I personally would â€œcomputeâ€ the numbers via a proof and I think the authors did the same. How exactly, however, I donâ€™t know.</p>
<p>I will give two ways to prove the formula for the true values.</p>
<section id="using-a-system-of-linear-equations" class="level5 unnumbered">
<h5 class="unnumbered anchored" data-anchor-id="using-a-system-of-linear-equations">Using a system of linear equations</h5>
<p>A straightforward way is to solve a linear system of equations. Let <span class="math inline">\(\mathbf{v}\)</span> be the vector of the true values <span class="math inline">\(\mathbf{v} = (v_1, \dots, v_5)\)</span>. Then <span class="math inline">\(v\)</span> is a solution to the system of linear equations <span class="math display">\[
P \mathbf{v} + \mathbf{b}
= \mathbf{v}
\]</span> with <span class="math display">\[
P = \begin{pmatrix}
0 &amp; 0.5 &amp; 0   &amp; 0   &amp; 0   \\
0.5 &amp; 0 &amp; 0.5 &amp; 0   &amp; 0   \\
0   &amp; 0.5 &amp; 0 &amp; 0.5 &amp; 0   \\
0   &amp; 0   &amp; 0.5 &amp; 0 &amp; 0.5 \\
0   &amp; 0   &amp; 0   &amp; 0.5 &amp; 0
\end{pmatrix}, \quad
\mathbf{b} = \begin{pmatrix}
0 \\
0 \\
0 \\
0 \\
0.5
\end{pmatrix}
\]</span> So <span class="math inline">\(\mathbf{v} = (I - P)^{-1} \mathbf{b}\)</span>.</p>
<p>For fun letâ€™s see how we can solve this using python. We can use the <code>sympy</code> package to solve the system of linear equations exactly.</p>
<div id="2d933f4d" class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="annotated-cell-17"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><span id="annotated-cell-17-1"><a href="#annotated-cell-17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># === exact solution for the random walk problem ===</span></span>
<span id="annotated-cell-17-2"><a href="#annotated-cell-17-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sympy <span class="im">as</span> sp</span>
<span id="annotated-cell-17-3"><a href="#annotated-cell-17-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-17-4"><a href="#annotated-cell-17-4" aria-hidden="true" tabindex="-1"></a><span class="co"># transition matrix</span></span>
<span id="annotated-cell-17-5"><a href="#annotated-cell-17-5" aria-hidden="true" tabindex="-1"></a>P2 <span class="op">=</span> sp.Matrix(</span>
<span id="annotated-cell-17-6"><a href="#annotated-cell-17-6" aria-hidden="true" tabindex="-1"></a>    [</span>
<span id="annotated-cell-17-7"><a href="#annotated-cell-17-7" aria-hidden="true" tabindex="-1"></a>        [<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>],</span>
<span id="annotated-cell-17-8"><a href="#annotated-cell-17-8" aria-hidden="true" tabindex="-1"></a>        [<span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>],</span>
<span id="annotated-cell-17-9"><a href="#annotated-cell-17-9" aria-hidden="true" tabindex="-1"></a>        [<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>],</span>
<span id="annotated-cell-17-10"><a href="#annotated-cell-17-10" aria-hidden="true" tabindex="-1"></a>        [<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>],</span>
<span id="annotated-cell-17-11"><a href="#annotated-cell-17-11" aria-hidden="true" tabindex="-1"></a>        [<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>],</span>
<span id="annotated-cell-17-12"><a href="#annotated-cell-17-12" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="annotated-cell-17-13"><a href="#annotated-cell-17-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="annotated-cell-17-14"><a href="#annotated-cell-17-14" aria-hidden="true" tabindex="-1"></a>P <span class="op">=</span> P2 <span class="op">/</span> <span class="dv">2</span></span>
<span id="annotated-cell-17-15"><a href="#annotated-cell-17-15" aria-hidden="true" tabindex="-1"></a><span class="co"># reward</span></span>
<span id="annotated-cell-17-16"><a href="#annotated-cell-17-16" aria-hidden="true" tabindex="-1"></a>b <span class="op">=</span> sp.Matrix([<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>]) <span class="op">/</span> <span class="dv">2</span></span>
<span id="annotated-cell-17-17"><a href="#annotated-cell-17-17" aria-hidden="true" tabindex="-1"></a></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-17" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-17-18" class="code-annotation-target"><a href="#annotated-cell-17-18" aria-hidden="true" tabindex="-1"></a><span class="co"># compute (I - P)^{-1} b</span></span>
<span id="annotated-cell-17-19"><a href="#annotated-cell-17-19" aria-hidden="true" tabindex="-1"></a>I <span class="op">=</span> sp.eye(<span class="dv">5</span>)</span>
<span id="annotated-cell-17-20"><a href="#annotated-cell-17-20" aria-hidden="true" tabindex="-1"></a>I_minus_P <span class="op">=</span> I <span class="op">-</span> P</span>
<span id="annotated-cell-17-21"><a href="#annotated-cell-17-21" aria-hidden="true" tabindex="-1"></a>I_minus_P_inv <span class="op">=</span> I_minus_P.inv()</span>
<span id="annotated-cell-17-22"><a href="#annotated-cell-17-22" aria-hidden="true" tabindex="-1"></a>v <span class="op">=</span> I_minus_P_inv <span class="op">*</span> b</span>
<span id="annotated-cell-17-23"><a href="#annotated-cell-17-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-17-24"><a href="#annotated-cell-17-24" aria-hidden="true" tabindex="-1"></a><span class="co"># display results</span></span>
<span id="annotated-cell-17-25"><a href="#annotated-cell-17-25" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"(I - P)^{-1}:"</span>)</span>
<span id="annotated-cell-17-26"><a href="#annotated-cell-17-26" aria-hidden="true" tabindex="-1"></a>sp.pprint(I_minus_P_inv)</span>
<span id="annotated-cell-17-27"><a href="#annotated-cell-17-27" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">v:"</span>)</span>
<span id="annotated-cell-17-28"><a href="#annotated-cell-17-28" aria-hidden="true" tabindex="-1"></a>sp.pprint(v)</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-17" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-17" data-code-lines="18" data-code-annotation="1">There are ways to solve the sysemt <span class="math inline">\((I-P)\mathbf{v} = \mathbf{b}\)</span> directly I just stuck with the notationally simpler method here.</span>
</dd>
</dl>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>(I - P)^{-1}:
âŽ¡5/3  4/3  1  2/3  1/3âŽ¤
âŽ¢                     âŽ¥
âŽ¢4/3  8/3  2  4/3  2/3âŽ¥
âŽ¢                     âŽ¥
âŽ¢ 1    2   3   2    1 âŽ¥
âŽ¢                     âŽ¥
âŽ¢2/3  4/3  2  8/3  4/3âŽ¥
âŽ¢                     âŽ¥
âŽ£1/3  2/3  1  4/3  5/3âŽ¦

v:
âŽ¡1/6âŽ¤
âŽ¢   âŽ¥
âŽ¢1/3âŽ¥
âŽ¢   âŽ¥
âŽ¢1/2âŽ¥
âŽ¢   âŽ¥
âŽ¢2/3âŽ¥
âŽ¢   âŽ¥
âŽ£5/6âŽ¦</code></pre>
</div>
</div>
</section>
<section id="using-a-recursive-relation" class="level5 unnumbered">
<h5 class="unnumbered anchored" data-anchor-id="using-a-recursive-relation">Using a recursive relation</h5>
<p>Another way is similar to a trick we have used before to turn the recurrence into a recursive system in the proof of <a href="05-monte-carlo-methods.html#thm-strip-problem" class="quarto-xref">Theorem&nbsp;<span>5.1</span></a>.</p>
<p>Let <span class="math inline">\(f(0) = 0\)</span> and <span class="math inline">\(f(1) = 1\)</span> and define <span class="math inline">\(f(i) = 2f(i-1) - f(i-2)\)</span>. The solution to this recursion is <span class="math inline">\(f(i) = i\)</span>. Then rescaling <span class="math inline">\(f\)</span> such that <span class="math inline">\(v(6) = 1\)</span> gives <span class="math inline">\(v(i) = \frac{f(i)}{6} = \frac{i}{6}\)</span>.</p>
</section>
</div>
</section>
<section id="optimality-of-td0" class="level2" data-number="6.3">
<h2 data-number="6.3" class="anchored" data-anchor-id="optimality-of-td0"><span class="header-section-number">6.3</span> Optimality of TD(0)</h2>
<p>Batch updating is like off-line updating only that the value function <span class="math inline">\(V\)</span> is constant over a whole batch instead of a single episode. Batch every-visit MC is this <span id="eq-batch-updating-mc"><span class="math display">\[
V(s) \gets V(s) + \alpha \sum_{(i,t) \in \mathcal{T}(s)} G_t^{(i)} - V(s),
\tag{6.5}\]</span></span> and TD(0) batch updating <span id="eq-batch-updating-td"><span class="math display">\[
V(s) \gets V(s) + \alpha \sum_{(i,t) \in \mathcal{T}(s)} R_{t+1}  + \gamma V(S_{t+1}) - V(S_t)
\tag{6.6}\]</span></span> with <span class="math inline">\(\mathcal{T}(s)\)</span> the set of all visits to <span class="math inline">\(s\)</span> in the batch.</p>
<p>General these update rules have the form for some fixed <span class="math inline">\(v = V(S)\)</span> <span class="math display">\[
v \gets v + \alpha [b - av]
\]</span> for fixed <span class="math inline">\(a,b \geq 0\)</span></p>
<p>Iterating this for small enough <span class="math inline">\(\alpha\)</span> converges. Letâ€™s talk about this in more detail.</p>
<section id="linear-fixed-point-iteration" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="linear-fixed-point-iteration">Linear fixed point iteration</h3>
<p>Letâ€™s discuss the convergence behaviour of a recursive sequence using the general update rule from above <span class="math display">\[
v_{t+1} = v_t + \alpha \cdot ( b - a v_t)
\]</span> with <span class="math inline">\(v_0 = c\)</span> for some arbitrary <span class="math inline">\(c\)</span>. This is a fixed point iteration for an affine function.</p>
<p>If <span class="math inline">\(\alpha = 0\)</span> then this sequence is just <span class="math inline">\(c\)</span>. The same is true if <span class="math inline">\(a = b = 0\)</span>. If only <span class="math inline">\(a = 0\)</span> but <span class="math inline">\(b \neq 0\)</span> then the sequence diverges.</p>
<p>So from now on let <span class="math inline">\(\alpha &gt; 0\)</span>, <span class="math inline">\(a &gt; 0\)</span>, and <span class="math inline">\(b \neq 0\)</span>. If the sequence converges it has to converge to the unique fixed point <span class="math inline">\(v^*\)</span> <span class="math display">\[
v^* = v^* + \alpha \cdot ( b - a v^*) \Longleftrightarrow v^* = \frac{b}{a}.
\]</span></p>
<p>Towards the convergence we have <span class="math display">\[
\begin{split}
v_{t+1} - v^* &amp;= (1 - \alpha a) v_t + \alpha b - v^* \\
&amp;= (1 - \alpha a) v_t - (1 - \alpha a) v^* \\
&amp;= (1 - \alpha a) (v_t - v^*)
\end{split}
\]</span></p>
<p>Recursively we get <span class="math inline">\(v_t - v^* = (1 - \alpha a)^t (c - v^*)\)</span>. So the sequence converges, if and only if, <span class="math inline">\(|1 - \alpha a| &lt; 1\)</span> which is equivalent to <span class="math display">\[
0 &lt; \alpha &lt; \frac{2}{a}
\]</span> So this is the condition for the sequence to converge.</p>
<p>In ML we also usually have <span class="math inline">\(0 &lt; 1- \alpha \cdot a &lt; 1\)</span>, which gives a smooth convergence, in the other convergence case <span class="math inline">\(-1 &lt; 1 - \alpha \cdot a &lt; 0\)</span> the sign of the sequence flips. All three cases are here in a sample plot</p>
<div id="5315a20f" class="cell" data-execution_count="16">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> iterate(v, a, b, alpha):</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> v <span class="op">+</span> alpha <span class="op">*</span> (b <span class="op">-</span> a <span class="op">*</span> v)</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> iterate_n(c, a, b, alpha, n):</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>    v <span class="op">=</span> c</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>    vs <span class="op">=</span> [v]</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(n):</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>        v <span class="op">=</span> iterate(v, a, b, alpha)</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>        vs.append(v)</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> vs</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>a <span class="op">=</span> <span class="dv">2</span></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>b <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>positive_contraction <span class="op">=</span> iterate_n(<span class="op">-</span><span class="fl">0.25</span>, a, b, <span class="fl">0.05</span>, <span class="dv">50</span>)</span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>negative_contraction <span class="op">=</span> iterate_n(<span class="fl">1.2</span>, a, b, <span class="fl">0.9</span>, <span class="dv">50</span>)</span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>expansion <span class="op">=</span> iterate_n(<span class="fl">0.505</span>, a, b, <span class="fl">1.04</span>, <span class="dv">50</span>)</span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>plt.plot(positive_contraction, label<span class="op">=</span><span class="vs">r"smooth convergence: </span><span class="dv">$</span><span class="vs">0 &lt; 1 - </span><span class="ch">\a</span><span class="vs">lpha a &lt; 1</span><span class="dv">$</span><span class="vs">"</span>)</span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>plt.plot(negative_contraction, label<span class="op">=</span><span class="vs">r"flip flop convergence: </span><span class="dv">$</span><span class="vs">-1 &lt; 1 - </span><span class="ch">\a</span><span class="vs">lpha a &lt; 0</span><span class="dv">$</span><span class="vs">"</span>)</span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a>plt.plot(expansion, label<span class="op">=</span><span class="vs">r"divergence: </span><span class="dv">$</span><span class="vs">1 - </span><span class="ch">\a</span><span class="vs">lpha a &lt; -1</span><span class="dv">$</span><span class="vs">"</span>)</span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a>plt.ylim(<span class="op">-</span><span class="fl">0.5</span>, <span class="fl">1.5</span>)</span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="06-temporal-difference-learning_files/figure-html/cell-16-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-10"><img src="06-temporal-difference-learning_files/figure-html/cell-16-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>Another way prove convergence is to use the Banach fixed point theorem for contractions.</p>
<div id="def-contraction" class="theorem definition">
<p><span class="theorem-title"><strong>Definition 6.1</strong></span> A contraction, on a metric space <span class="math inline">\((M,â€‰d)\)</span> is a function <span class="math inline">\(f\)</span> from <span class="math inline">\(M\)</span> to itself, with the property that there is some real number <span class="math inline">\(0 \leq k &lt; 1\)</span> such that for all <span class="math inline">\(x\)</span> and <span class="math inline">\(y\)</span> in <span class="math inline">\(M\)</span>,</p>
<p><span class="math display">\[
d(f(x),f(y))\leq k\,d(x,y)
\]</span></p>
</div>
<p>The map <span class="math inline">\(f(v) =  v + \alpha (b - a v)\)</span> is a contraction mapping if <span class="math inline">\(1 - \alpha a| &lt; 1\)</span> since <span class="math display">\[
\begin{split}
|f(v) - f(v')| &amp;= |v - v' + \alpha (a v' - a v)| \\
&amp;= |(1 - \alpha a)(v - v')| \\
&amp;= |1 - \alpha a||v - v'|
\end{split}
\]</span></p>
<p>We will use a similar argument for the vector case</p>
<section id="the-vector-case" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="the-vector-case">The vector case</h4>
<p>When dealing with a value function, we can represent it as a vector. In this cas ethe linear fixed point iteration look like this:</p>
<p><span id="eq-batch-updating"><span class="math display">\[
\mathbf{v}_{t+1} = \mathbf{v}_t + \alpha (\mathbf{b} - A \mathbf{v}_t)
\tag{6.7}\]</span></span></p>
<p>Consider any norm <span class="math inline">\(||\cdot||\)</span> if in this norm <span class="math inline">\(||I - \alpha A|| = k &lt; 1\)</span>, then <span class="math inline">\(\mathbf{v} \to \mathbf{v} + \alpha (\mathbf{b} - A \mathbf{v})\)</span> is a contraction since <span class="math display">\[
\begin{split}
|| \mathbf{v} - \mathbf{v}' + \alpha A (\mathbf{v}' - \mathbf{v}) || &amp;= ||(I - \alpha A)(\mathbf{v}' - \mathbf{v})|| \\
&amp;\leq k || \mathbf{v}' - \mathbf{v} ||
\end{split}
\]</span></p>
<p>However, this depends on the operator norm of <span class="math inline">\(I - \alpha A\)</span>. To get rid of this dependency, we have that the spectral radius <span class="math inline">\(\rho(I - \alpha A)\)</span> is the right condition to ensure convergence. The clue is spectra norm <span class="math inline">\(&lt; 1\)</span> <span class="math inline">\(\Longleftrightarrow\)</span> <span class="math inline">\(|| 1 - \alpha A|| &lt; 1\)</span> for some norm.</p>
</section>
</section>
<section id="random-walk-under-batch-updating" class="level3" data-number="6.3.1">
<h3 data-number="6.3.1" class="anchored" data-anchor-id="random-walk-under-batch-updating"><span class="header-section-number">6.3.1</span> Random walk under batch updating</h3>
<p>Letâ€™s apply batch updating to the random walk example <a href="#exm-6.2" class="quarto-xref">Example&nbsp;<span>6.2</span></a>. We can adapt batch updating mc <a href="#eq-batch-updating-mc" class="quarto-xref">Equation&nbsp;<span>6.5</span></a> and batch-updating TD(0) <a href="#eq-batch-updating-td" class="quarto-xref">Equation&nbsp;<span>6.6</span></a> like so <span class="math display">\[
\begin{split}
V(i) \gets V(i) + \alpha [&amp;R(i) \cdot (1 -  V(i)) \\
+ &amp;L(i) \cdot (0 - V(i))]
\end{split}
\]</span> where <span class="math inline">\(N(s)\)</span> and <span class="math inline">\(R(s)\)</span> are the number of all the visits to state <span class="math inline">\(s\)</span> that ended on the left and right, respectively. <span class="math display">\[
\begin{split}
V(i) \gets V(i) + \alpha [ &amp;T(i,i-1) (V(i-1)-V(i)) \\
+ &amp;T(i,i+1) (V(i+1)-V(i))] ,
\end{split}
\]</span> where <span class="math inline">\(T(i,j)\)</span> is the number of transitions from <span class="math inline">\(i\)</span> to <span class="math inline">\(j\)</span>. Also keep in mind that <span class="math inline">\(V(0) = 0\)</span> and <span class="math inline">\(V(6) = 1\)</span> are fixed in this update rule.</p>
<p>Itâ€™s easy to find the limit of the batch updating every-visit mc rule. Each <span class="math inline">\(V(i)\)</span> can be treated as a single scalar updating. Thus the limit is <span class="math display">\[
\lim_{t \to \infty}V_t(i) = \begin{cases} \frac{R(i)}{L(i) + R(i)}, &amp;\text{if } L(i) + R(i) &gt; 0 \\ V_0(i), &amp;\text{ else} \end{cases}
\]</span></p>
<p>For the TD(0) case we can vectorise the individual updates to get an update formula of the form <span class="math display">\[
\mathbf{v} \gets \mathbf{v} + \alpha (\mathbf{b} - \mathbf{A} \mathbf{v})
\]</span> where <span class="math inline">\(\mathbf{v}\)</span> also includes the two terminal states. Then <span class="math inline">\(\mathbf{b}_i = [i = 6]\)</span> and <span class="math display">\[
A_{i,j} = \begin{cases}
1, &amp;i = j \in \{0,6\} \\
T(i,i-1), &amp;j = i-1 \\
T(i,i+1), &amp;j = i+1 \\
T(i,i-1) + T(i,i+1), &amp;j = i \in \{1, \dots, 5\}
\end{cases}
\]</span></p>
<p>So if we start this with <span class="math inline">\(\mathbf{v}^{(0)}_0 = 0\)</span> and <span class="math inline">\(\mathbf{v}^{(0)}_6 = 1\)</span> and follow the upate rule given above, this gives just the update given before. Actually, since the limit is unique the conditions on <span class="math inline">\(\mathbf{v}^{(0)}_0\)</span> and <span class="math inline">\(\mathbf{v}^{(0)}_6\)</span> can be relaxed and it would still converge to the same solution, which is: <span class="math display">\[
\lim_{t \to \infty} \mathbf{v}^{(t)} = A^{-1}\mathbf{b}
\]</span></p>
<p>Well, actually this is not quite true, in case both <span class="math inline">\(T(i,i-1)\)</span> and <span class="math inline">\(T(i,i+1)\)</span> are zero, so there are no visits to <span class="math inline">\(i\)</span>, the initial value <span class="math inline">\(V_0(i)\)</span> doesnâ€™t change. In these cases we have to define <span class="math inline">\(\mathbf{b}_i = 1\)</span> and <span class="math inline">\(A_{i,i} = 1, A_{i,j} = 0\)</span> for <span class="math inline">\(j \neq i\)</span>.</p>
<p>Now we have enough preparations to try these out.</p>
<div id="exm-6.3" class="theorem example">
<p><span class="theorem-title"><strong>Example 6.3</strong></span> <strong>Random walk under batch updating</strong> <span class="citation" data-cites="sutton2018">(<a href="#ref-sutton2018" role="doc-biblioref">Sutton and Barto 2018</a>, Example 6.3)</span></p>
<p>We want to compare the limits of batch-updating for mc and td.</p>
<p>We start with the MC case:</p>
<div id="40d78b22" class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># === batch-update every-visit mc ===</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> count_exits(episode, env_size<span class="op">=</span><span class="dv">5</span>):</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a><span class="co">    Count every-visit state occurrences for a single random-walk episode.</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a><span class="co">    Visits are attributed to the side the episode ends on:</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a><span class="co">    left exit â†’ row 0, right exit â†’ row 1.</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>    visits <span class="op">=</span> np.bincount(episode, minlength<span class="op">=</span>env_size <span class="op">+</span> <span class="dv">2</span>)</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>    zeros <span class="op">=</span> np.zeros_like(visits)</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> episode[<span class="op">-</span><span class="dv">1</span>] <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> np.vstack((visits, zeros))</span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> np.vstack((zeros, visits))</span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> batch_mc_update_limit(exits, initial<span class="op">=</span><span class="fl">0.5</span>):</span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a><span class="co">    Compute the fixed point of iterated every-visit MC batch updates</span></span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a><span class="co">    for the given exit counts.</span></span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a>    total <span class="op">=</span> exits.<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># avoid divide-by-zero warnings for unvisited states</span></span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> np.errstate(invalid<span class="op">=</span><span class="st">"ignore"</span>):</span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a>        limit <span class="op">=</span> np.where(total <span class="op">&gt;</span> <span class="dv">0</span>, exits[<span class="dv">1</span>] <span class="op">/</span> total, initial)</span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-29"><a href="#cb18-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># enforce terminal values</span></span>
<span id="cb18-30"><a href="#cb18-30" aria-hidden="true" tabindex="-1"></a>    limit[<span class="dv">0</span>] <span class="op">=</span> <span class="fl">0.0</span></span>
<span id="cb18-31"><a href="#cb18-31" aria-hidden="true" tabindex="-1"></a>    limit[<span class="op">-</span><span class="dv">1</span>] <span class="op">=</span> <span class="fl">1.0</span></span>
<span id="cb18-32"><a href="#cb18-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> limit</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now the TD(0) case</p>
<div id="405091bc" class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># === batch-update TD(0) ===</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> count_transitions(episode, env_size<span class="op">=</span><span class="dv">5</span>):</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a><span class="co">    return matrix of transition counts for a single episode</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>    n_states <span class="op">=</span> env_size <span class="op">+</span> <span class="dv">2</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>    s <span class="op">=</span> np.asarray(episode[:<span class="op">-</span><span class="dv">1</span>], dtype<span class="op">=</span>np.int64)</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>    s_p <span class="op">=</span> np.asarray(episode[<span class="dv">1</span>:], dtype<span class="op">=</span>np.int64)</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>    transition_idx <span class="op">=</span> s <span class="op">*</span> n_states <span class="op">+</span> s_p</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>    flat <span class="op">=</span> np.bincount(transition_idx, minlength<span class="op">=</span>n_states <span class="op">*</span> n_states)</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> flat.reshape((n_states, n_states)).astype(<span class="bu">float</span>)</span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> batch_td_update_limit(transitions, initial<span class="op">=</span><span class="fl">0.5</span>):</span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a><span class="co">    Compute the fixed point of iterated batch TD(0) updates</span></span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a><span class="co">    for the given transition counts</span></span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a>    n <span class="op">=</span> transitions.shape[<span class="dv">0</span>]</span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a>    N <span class="op">=</span> transitions.copy()</span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, n <span class="op">-</span> <span class="dv">1</span>):</span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a>        N[i, i] <span class="op">-=</span> N[i, i <span class="op">-</span> <span class="dv">1</span>] <span class="op">+</span> N[i, i <span class="op">+</span> <span class="dv">1</span>]</span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a>    N[<span class="dv">0</span>, <span class="dv">0</span>] <span class="op">=</span> <span class="fl">1.0</span></span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a>    N[<span class="op">-</span><span class="dv">1</span>, <span class="op">-</span><span class="dv">1</span>] <span class="op">=</span> <span class="fl">1.0</span></span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true" tabindex="-1"></a>    b <span class="op">=</span> np.zeros(n, dtype<span class="op">=</span><span class="bu">float</span>)</span>
<span id="cb19-31"><a href="#cb19-31" aria-hidden="true" tabindex="-1"></a>    b[<span class="op">-</span><span class="dv">1</span>] <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb19-32"><a href="#cb19-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-33"><a href="#cb19-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># special case for unvisited states</span></span>
<span id="cb19-34"><a href="#cb19-34" aria-hidden="true" tabindex="-1"></a>    row_sums <span class="op">=</span> transitions.<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb19-35"><a href="#cb19-35" aria-hidden="true" tabindex="-1"></a>    unvisited_mask <span class="op">=</span> np.zeros(n, dtype<span class="op">=</span><span class="bu">bool</span>)</span>
<span id="cb19-36"><a href="#cb19-36" aria-hidden="true" tabindex="-1"></a>    unvisited_mask[<span class="dv">1</span>:<span class="op">-</span><span class="dv">1</span>] <span class="op">=</span> row_sums[<span class="dv">1</span>:<span class="op">-</span><span class="dv">1</span>] <span class="op">==</span> <span class="dv">0</span></span>
<span id="cb19-37"><a href="#cb19-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> unvisited_mask.<span class="bu">any</span>():</span>
<span id="cb19-38"><a href="#cb19-38" aria-hidden="true" tabindex="-1"></a>        rows <span class="op">=</span> np.nonzero(unvisited_mask)[<span class="dv">0</span>]</span>
<span id="cb19-39"><a href="#cb19-39" aria-hidden="true" tabindex="-1"></a>        N[rows, :] <span class="op">=</span> <span class="fl">0.0</span></span>
<span id="cb19-40"><a href="#cb19-40" aria-hidden="true" tabindex="-1"></a>        N[rows, rows] <span class="op">=</span> <span class="fl">1.0</span></span>
<span id="cb19-41"><a href="#cb19-41" aria-hidden="true" tabindex="-1"></a>        b[rows] <span class="op">=</span> initial</span>
<span id="cb19-42"><a href="#cb19-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-43"><a href="#cb19-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> np.linalg.solve(N, b)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now we can compare them</p>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> experimentititonification(random_walks, env_size<span class="op">=</span><span class="dv">5</span>):</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>    n_states <span class="op">=</span> env_size <span class="op">+</span> <span class="dv">2</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>    true_values <span class="op">=</span> np.array([i <span class="op">/</span> (env_size <span class="op">+</span> <span class="dv">1</span>) <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(n_states)])</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>    exits_by_replica <span class="op">=</span> np.zeros((batch_size, <span class="dv">2</span>, n_states), dtype<span class="op">=</span>np.int64)</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>    transitions_by_replica <span class="op">=</span> np.zeros((batch_size, n_states, n_states), dtype<span class="op">=</span><span class="bu">float</span>)</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>    rmse_per_replica_td <span class="op">=</span> np.zeros(batch_size, dtype<span class="op">=</span><span class="bu">float</span>)</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>    rmse_per_replica_mc <span class="op">=</span> np.zeros(batch_size, dtype<span class="op">=</span><span class="bu">float</span>)</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>    mean_rmse_td <span class="op">=</span> np.zeros(n_episodes, dtype<span class="op">=</span><span class="bu">float</span>)</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>    mean_rmse_mc <span class="op">=</span> np.zeros(n_episodes, dtype<span class="op">=</span><span class="bu">float</span>)</span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> episode_idx, episode_batch <span class="kw">in</span> <span class="bu">enumerate</span>(generated_walks):</span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> replica_idx, episode <span class="kw">in</span> <span class="bu">enumerate</span>(episode_batch):</span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>            transitions_by_replica[replica_idx] <span class="op">+=</span> count_transitions(episode, env_size)</span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>            exits_by_replica[replica_idx] <span class="op">+=</span> count_exits(episode, env_size)</span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a>            value_est_td <span class="op">=</span> batch_td_update_limit(transitions_by_replica[replica_idx])</span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a>            value_est_mc <span class="op">=</span> batch_mc_update_limit(exits_by_replica[replica_idx])</span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a>            diffs_td <span class="op">=</span> value_est_td[<span class="dv">1</span>:<span class="op">-</span><span class="dv">1</span>] <span class="op">-</span> true_values[<span class="dv">1</span>:<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a>            diffs_mc <span class="op">=</span> value_est_mc[<span class="dv">1</span>:<span class="op">-</span><span class="dv">1</span>] <span class="op">-</span> true_values[<span class="dv">1</span>:<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a>            rmse_per_replica_td[replica_idx] <span class="op">=</span> np.sqrt(np.mean(diffs_td<span class="op">**</span><span class="dv">2</span>))</span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a>            rmse_per_replica_mc[replica_idx] <span class="op">=</span> np.sqrt(np.mean(diffs_mc<span class="op">**</span><span class="dv">2</span>))</span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-27"><a href="#cb20-27" aria-hidden="true" tabindex="-1"></a>        mean_rmse_td[episode_idx] <span class="op">=</span> rmse_per_replica_td.mean()</span>
<span id="cb20-28"><a href="#cb20-28" aria-hidden="true" tabindex="-1"></a>        mean_rmse_mc[episode_idx] <span class="op">=</span> rmse_per_replica_mc.mean()</span>
<span id="cb20-29"><a href="#cb20-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-30"><a href="#cb20-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> mean_rmse_td, mean_rmse_mc</span>
<span id="cb20-31"><a href="#cb20-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-32"><a href="#cb20-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-33"><a href="#cb20-33" aria-hidden="true" tabindex="-1"></a>rng <span class="op">=</span> random.Random()</span>
<span id="cb20-34"><a href="#cb20-34" aria-hidden="true" tabindex="-1"></a>n_episodes <span class="op">=</span> <span class="dv">100</span></span>
<span id="cb20-35"><a href="#cb20-35" aria-hidden="true" tabindex="-1"></a>batch_size <span class="op">=</span> <span class="dv">24</span></span>
<span id="cb20-36"><a href="#cb20-36" aria-hidden="true" tabindex="-1"></a>generated_walks <span class="op">=</span> generate_random_walk_dataset(n_episodes, batch_size, rng, env_size<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb20-37"><a href="#cb20-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-38"><a href="#cb20-38" aria-hidden="true" tabindex="-1"></a>mean_rmse_td, mean_rmse_mc <span class="op">=</span> experimentititonification(generated_walks)</span>
<span id="cb20-39"><a href="#cb20-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-40"><a href="#cb20-40" aria-hidden="true" tabindex="-1"></a><span class="co"># plotting (unchanged)</span></span>
<span id="cb20-41"><a href="#cb20-41" aria-hidden="true" tabindex="-1"></a>plt.plot(mean_rmse_td, label<span class="op">=</span><span class="st">"TD(0) batch"</span>)</span>
<span id="cb20-42"><a href="#cb20-42" aria-hidden="true" tabindex="-1"></a>plt.plot(mean_rmse_mc, label<span class="op">=</span><span class="st">"every-visit MC batch"</span>)</span>
<span id="cb20-43"><a href="#cb20-43" aria-hidden="true" tabindex="-1"></a>plt.ylim(<span class="dv">0</span>, <span class="fl">0.25</span>)</span>
<span id="cb20-44"><a href="#cb20-44" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb20-45"><a href="#cb20-45" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="ss">f"Batch update limits (averaged over </span><span class="sc">{</span>batch_size<span class="sc">}</span><span class="ss"> replicas)"</span>)</span>
<span id="cb20-46"><a href="#cb20-46" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div id="fig-6.2-random-walk-under-batch-updating" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-6.2-random-walk-under-batch-updating-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div id="1807e2b8" class="cell" data-execution_count="19">
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="06-temporal-difference-learning_files/figure-html/cell-19-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-11" title="Figure&nbsp;6.6: Performance of TD(0) and every-visit MC under batch training on the random walk task [@sutton2018, Figure 6.2]."><img src="06-temporal-difference-learning_files/figure-html/cell-19-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-6.2-random-walk-under-batch-updating-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;6.6: Performance of TD(0) and every-visit MC under batch training on the random walk task <span class="citation" data-cites="sutton2018">(<a href="#ref-sutton2018" role="doc-biblioref">Sutton and Barto 2018, fig. 6.2</a>)</span>.
</figcaption>
</figure>
</div>
<p>We can see that TD(0) is just better than every-visit MC. Both methods have to generalise somehow from the limited data they are given and TD(0) is better in this example.</p>
</div>
<div id="exm-6.4-you-are-the-predictor" class="theorem example">
<p><span class="theorem-title"><strong>Example 6.4</strong></span> <strong>You are the Predictor </strong> <span class="citation" data-cites="sutton2018">(<a href="#ref-sutton2018" role="doc-biblioref">Sutton and Barto 2018</a>, Example 6.4)</span></p>
<p>TODO</p>
</div>
<div id="exr-6.7" class="theorem exercise">
<p><span class="theorem-title"><strong>Exercise 6.7</strong></span> Design an off-policy version of the TD(0) update that can be used with arbitrary target policy <span class="math inline">\(\pi\)</span> and covering behavior policy <span class="math inline">\(b\)</span>, using at each step <span class="math inline">\(t\)</span> the importance sampling ratio <span class="math inline">\(\rho_{t:t}\)</span> (5.3).</p>
</div>
<div id="sol-6.7" class="proof solution">
<p><span class="proof-title"><em>Solution 6.7</em>. </span>TODO read <span class="citation" data-cites="graves2022importance">Graves and Ghiassian (<a href="#ref-graves2022importance" role="doc-biblioref">2022</a>)</span></p>
<p>off-policy version of TD(0):</p>
<p><span class="math display">\[
\begin{split}
v_\pi(s) &amp;= \mathbb{E}_\pi[G \mid S_t = s] \\
&amp;= \mathbb{E}_\pi[R_{t+1} + \gamma G_{t+1} \mid S_t = s] \\
&amp;= \mathbb{E}_\pi [R_{t+1} + \gamma v_\pi(S_{t+1}) \mid S_t = s]
\end{split}
\]</span></p>
<p><span class="math display">\[
\begin{split}
v_\pi(s) &amp;= \mathbb{E}_b [R_{t+1} + \gamma v_\pi(S_{t+1}) \mid S_t = s] \\
&amp;= \sum_\tau R_{t+1} + \gamma
\end{split}
\]</span></p>
</div>
</section>
</section>
<section id="sarsa-on-policy-td-control" class="level2" data-number="6.4">
<h2 data-number="6.4" class="anchored" data-anchor-id="sarsa-on-policy-td-control"><span class="header-section-number">6.4</span> Sarsa: On-policy TD Control</h2>
<p>The uptare rule is <span class="math display">\[
Q(S_t,A_t) \gets Q(S_t,A_t) + \alpha \big[ R_{t+1} + \gamma Q(S_{t+1},A_{t+1}) - Q(S_t,A_t)]
\]</span></p>
<div id="lst-sarsa" class="listing-block listing quarto-float quarto-figure quarto-figure-left anchored">
<figure class="quarto-float quarto-float-lst figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-lst" id="lst-sarsa-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Listing&nbsp;6.2: First-visit MC prediction, for estimating <span class="math inline">\(V \approx v_\pi\)</span>
</figcaption>
<div aria-describedby="lst-sarsa-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="line-block"><strong>Algorithm parameters</strong>: step size $(0,1], small <span class="math inline">\(\varepsilon &gt; 0\)</span><br>
<strong>Initialisation</strong>: <span class="math inline">\(Q(s,a)\)</span> arbitrary for all <span class="math inline">\(s \in \mathcal{S}^+\)</span>, <span class="math inline">\(a \in \mathcal{A}\)</span>, except <span class="math inline">\(Q(\text{terminal}, \cdot) = 0\)</span><br>
<br>
Loop forever:<br>
&nbsp;&nbsp;&nbsp;&nbsp;Start episode and observe <span class="math inline">\(S\)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;Choose <span class="math inline">\(A\)</span> from <span class="math inline">\(S\)</span> using policy derived from <span class="math inline">\(Q\)</span> (e.g.&nbsp;<span class="math inline">\(\varepsilon\)</span>-greedy)<br>
&nbsp;&nbsp;&nbsp;&nbsp;While <span class="math inline">\(S\)</span> is not termnial:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Take action <span class="math inline">\(A\)</span>, observe <span class="math inline">\(R,S'\)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Choose <span class="math inline">\(A'\)</span> from <span class="math inline">\(S'\)</span> using policy derived from <span class="math inline">\(Q\)</span> (e.g.&nbsp;<span class="math inline">\(\varepsilon\)</span>-greedy)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="math inline">\(Q(S,A) \gets Q(S,A) + \alpha [R + \gamma Q(S',A') - Q(S,A)]\)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="math inline">\(S \gets S'\)</span>, <span class="math inline">\(A \gets A'\)</span></div>
</div>
</figure>
</div>
<div id="exm-6.5-windy-gridworld" class="theorem example">
<p><span class="theorem-title"><strong>Example 6.5</strong></span> <strong>Windy Gridwolrd</strong> <span class="citation" data-cites="sutton2018">(<a href="#ref-sutton2018" role="doc-biblioref">Sutton and Barto 2018</a>, Example 6.5)</span></p>
<p>So here is the implementation of SARSA. Note that I hardcoded the -1 reward into the sarsa algorithm. Just because I am always afraid that the code will be too slow.</p>
<div id="3db419e2" class="cell" data-execution_count="20">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># === implementation Sarsa ===</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> random</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> select_greedy_action(state, Q, action_space):</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">max</span>(action_space, key<span class="op">=</span><span class="kw">lambda</span> a: Q[(state, a)])</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> select_Îµ_greedy_action(state, Q, Îµ, action_space, rng):</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> rng.random() <span class="op">&lt;</span> Îµ:</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> rng.choice(action_space)</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> select_greedy_action(state, Q, action_space)</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> run_sarsa_episode(env, Q, Î±, Îµ, rng):</span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>    action_space <span class="op">=</span> env.action_space</span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>    state <span class="op">=</span> env.reset()</span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>    action <span class="op">=</span> select_Îµ_greedy_action(state, Q, Îµ, action_space, rng)</span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a>    terminated <span class="op">=</span> <span class="va">False</span></span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a>    step_count <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="kw">not</span> terminated:</span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a>        step_count <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a>        next_state, terminated <span class="op">=</span> env.step(action)</span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true" tabindex="-1"></a>        reward <span class="op">=</span> <span class="op">-</span><span class="dv">1</span></span>
<span id="cb21-29"><a href="#cb21-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> terminated:</span>
<span id="cb21-30"><a href="#cb21-30" aria-hidden="true" tabindex="-1"></a>            <span class="co"># terminal state: next-state action-value is zero</span></span>
<span id="cb21-31"><a href="#cb21-31" aria-hidden="true" tabindex="-1"></a>            td_error <span class="op">=</span> reward <span class="op">-</span> Q[(state, action)]</span>
<span id="cb21-32"><a href="#cb21-32" aria-hidden="true" tabindex="-1"></a>            Q[(state, action)] <span class="op">+=</span> Î± <span class="op">*</span> td_error</span>
<span id="cb21-33"><a href="#cb21-33" aria-hidden="true" tabindex="-1"></a>            <span class="cf">break</span></span>
<span id="cb21-34"><a href="#cb21-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-35"><a href="#cb21-35" aria-hidden="true" tabindex="-1"></a>        next_action <span class="op">=</span> select_Îµ_greedy_action(next_state, Q, Îµ, action_space, rng)</span>
<span id="cb21-36"><a href="#cb21-36" aria-hidden="true" tabindex="-1"></a>        td_error <span class="op">=</span> reward <span class="op">+</span> Q[(next_state, next_action)] <span class="op">-</span> Q[(state, action)]</span>
<span id="cb21-37"><a href="#cb21-37" aria-hidden="true" tabindex="-1"></a>        Q[(state, action)] <span class="op">+=</span> Î± <span class="op">*</span> td_error</span>
<span id="cb21-38"><a href="#cb21-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-39"><a href="#cb21-39" aria-hidden="true" tabindex="-1"></a>        state <span class="op">=</span> next_state</span>
<span id="cb21-40"><a href="#cb21-40" aria-hidden="true" tabindex="-1"></a>        action <span class="op">=</span> next_action</span>
<span id="cb21-41"><a href="#cb21-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-42"><a href="#cb21-42" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> step_count</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="840bd9b3" class="cell" data-execution_count="21">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> matplotlib.colors <span class="im">import</span> ListedColormap</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> math</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> WindyGridWorld:</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>,</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>        rng,</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>        column_wind_strengths<span class="op">=</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">1</span>, <span class="dv">0</span>),</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>        height<span class="op">=</span><span class="dv">7</span>,</span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>        move_set<span class="op">=</span><span class="st">"king"</span>,</span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>        start_pos<span class="op">=</span>(<span class="dv">0</span>, <span class="dv">3</span>),</span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>        target_pos<span class="op">=</span>(<span class="dv">7</span>, <span class="dv">3</span>),</span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>        wind_randomness<span class="op">=</span><span class="fl">0.0</span>,</span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>    ):</span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.rng <span class="op">=</span> rng</span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.column_wind_strengths <span class="op">=</span> column_wind_strengths</span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.width <span class="op">=</span> <span class="bu">len</span>(column_wind_strengths)</span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.height <span class="op">=</span> height</span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.state_space <span class="op">=</span> [</span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a>            (x, y) <span class="cf">for</span> x <span class="kw">in</span> <span class="bu">range</span>(<span class="va">self</span>.width) <span class="cf">for</span> y <span class="kw">in</span> <span class="bu">range</span>(<span class="va">self</span>.height)</span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.action_space <span class="op">=</span> <span class="va">self</span>._make_action_space(move_set)</span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.start_pos <span class="op">=</span> np.array(start_pos, dtype<span class="op">=</span><span class="bu">int</span>)</span>
<span id="cb22-29"><a href="#cb22-29" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.target_pos <span class="op">=</span> np.array(target_pos, dtype<span class="op">=</span><span class="bu">int</span>)</span>
<span id="cb22-30"><a href="#cb22-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-31"><a href="#cb22-31" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.wind_randomness <span class="op">=</span> wind_randomness</span>
<span id="cb22-32"><a href="#cb22-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-33"><a href="#cb22-33" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _make_action_space(<span class="va">self</span>, move_set: <span class="bu">str</span>):</span>
<span id="cb22-34"><a href="#cb22-34" aria-hidden="true" tabindex="-1"></a>        ortho <span class="op">=</span> [(<span class="dv">0</span>, v) <span class="cf">for</span> v <span class="kw">in</span> (<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>)] <span class="op">+</span> [(h, <span class="dv">0</span>) <span class="cf">for</span> h <span class="kw">in</span> (<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>)]</span>
<span id="cb22-35"><a href="#cb22-35" aria-hidden="true" tabindex="-1"></a>        diag <span class="op">=</span> [(h, v) <span class="cf">for</span> h <span class="kw">in</span> (<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>) <span class="cf">for</span> v <span class="kw">in</span> (<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>)]</span>
<span id="cb22-36"><a href="#cb22-36" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> move_set <span class="op">==</span> <span class="st">"king"</span>:</span>
<span id="cb22-37"><a href="#cb22-37" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> ortho</span>
<span id="cb22-38"><a href="#cb22-38" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> move_set <span class="op">==</span> <span class="st">"queen"</span>:</span>
<span id="cb22-39"><a href="#cb22-39" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> ortho <span class="op">+</span> diag</span>
<span id="cb22-40"><a href="#cb22-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-41"><a href="#cb22-41" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> reset(<span class="va">self</span>):</span>
<span id="cb22-42"><a href="#cb22-42" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.pos <span class="op">=</span> <span class="va">self</span>.start_pos.copy()</span>
<span id="cb22-43"><a href="#cb22-43" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> (<span class="bu">int</span>(<span class="va">self</span>.pos[<span class="dv">0</span>]), <span class="bu">int</span>(<span class="va">self</span>.pos[<span class="dv">1</span>]))</span>
<span id="cb22-44"><a href="#cb22-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-45"><a href="#cb22-45" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> step(<span class="va">self</span>, action):</span>
<span id="cb22-46"><a href="#cb22-46" aria-hidden="true" tabindex="-1"></a>        <span class="co"># move</span></span>
<span id="cb22-47"><a href="#cb22-47" aria-hidden="true" tabindex="-1"></a>        action <span class="op">=</span> np.array(action, dtype<span class="op">=</span><span class="bu">int</span>)</span>
<span id="cb22-48"><a href="#cb22-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-49"><a href="#cb22-49" aria-hidden="true" tabindex="-1"></a>        base_wind <span class="op">=</span> <span class="va">self</span>.column_wind_strengths[<span class="va">self</span>.pos[<span class="dv">0</span>]]</span>
<span id="cb22-50"><a href="#cb22-50" aria-hidden="true" tabindex="-1"></a>        effective_wind <span class="op">=</span> base_wind</span>
<span id="cb22-51"><a href="#cb22-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-52"><a href="#cb22-52" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> base_wind <span class="op">!=</span> <span class="dv">0</span>:</span>
<span id="cb22-53"><a href="#cb22-53" aria-hidden="true" tabindex="-1"></a>            sample <span class="op">=</span> <span class="va">self</span>.rng.random()</span>
<span id="cb22-54"><a href="#cb22-54" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> sample <span class="op">&lt;</span> <span class="va">self</span>.wind_randomness:</span>
<span id="cb22-55"><a href="#cb22-55" aria-hidden="true" tabindex="-1"></a>                effective_wind <span class="op">-=</span> <span class="dv">1</span></span>
<span id="cb22-56"><a href="#cb22-56" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> sample <span class="op">&gt;</span> <span class="fl">1.0</span> <span class="op">-</span> <span class="va">self</span>.wind_randomness:</span>
<span id="cb22-57"><a href="#cb22-57" aria-hidden="true" tabindex="-1"></a>                effective_wind <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb22-58"><a href="#cb22-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-59"><a href="#cb22-59" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.pos <span class="op">+=</span> action <span class="op">+</span> (<span class="dv">0</span>, effective_wind)</span>
<span id="cb22-60"><a href="#cb22-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-61"><a href="#cb22-61" aria-hidden="true" tabindex="-1"></a>        <span class="co"># clip</span></span>
<span id="cb22-62"><a href="#cb22-62" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.pos <span class="op">=</span> np.clip(</span>
<span id="cb22-63"><a href="#cb22-63" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.pos,</span>
<span id="cb22-64"><a href="#cb22-64" aria-hidden="true" tabindex="-1"></a>            (<span class="dv">0</span>, <span class="dv">0</span>),</span>
<span id="cb22-65"><a href="#cb22-65" aria-hidden="true" tabindex="-1"></a>            (<span class="va">self</span>.width <span class="op">-</span> <span class="dv">1</span>, <span class="va">self</span>.height <span class="op">-</span> <span class="dv">1</span>),</span>
<span id="cb22-66"><a href="#cb22-66" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb22-67"><a href="#cb22-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-68"><a href="#cb22-68" aria-hidden="true" tabindex="-1"></a>        <span class="co"># output</span></span>
<span id="cb22-69"><a href="#cb22-69" aria-hidden="true" tabindex="-1"></a>        reached_goal <span class="op">=</span> np.array_equal(</span>
<span id="cb22-70"><a href="#cb22-70" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.pos,</span>
<span id="cb22-71"><a href="#cb22-71" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.target_pos,</span>
<span id="cb22-72"><a href="#cb22-72" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb22-73"><a href="#cb22-73" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> (<span class="bu">int</span>(<span class="va">self</span>.pos[<span class="dv">0</span>]), <span class="bu">int</span>(<span class="va">self</span>.pos[<span class="dv">1</span>])), reached_goal</span>
<span id="cb22-74"><a href="#cb22-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-75"><a href="#cb22-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-76"><a href="#cb22-76" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> windy_grid_world_experiment(env, n_episodes, Î±, Îµ, rng):</span>
<span id="cb22-77"><a href="#cb22-77" aria-hidden="true" tabindex="-1"></a>    Q <span class="op">=</span> {</span>
<span id="cb22-78"><a href="#cb22-78" aria-hidden="true" tabindex="-1"></a>        (state, action): <span class="fl">0.0</span> <span class="cf">for</span> state <span class="kw">in</span> env.state_space <span class="cf">for</span> action <span class="kw">in</span> env.action_space</span>
<span id="cb22-79"><a href="#cb22-79" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb22-80"><a href="#cb22-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-81"><a href="#cb22-81" aria-hidden="true" tabindex="-1"></a>    Q_history <span class="op">=</span> [Q.copy()]</span>
<span id="cb22-82"><a href="#cb22-82" aria-hidden="true" tabindex="-1"></a>    steps <span class="op">=</span> []</span>
<span id="cb22-83"><a href="#cb22-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-84"><a href="#cb22-84" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> episode <span class="kw">in</span> <span class="bu">range</span>(n_episodes):</span>
<span id="cb22-85"><a href="#cb22-85" aria-hidden="true" tabindex="-1"></a>        steps.append(run_sarsa_episode(env, Q, Î±, Îµ, rng))</span>
<span id="cb22-86"><a href="#cb22-86" aria-hidden="true" tabindex="-1"></a>        Q_history.append(Q.copy())</span>
<span id="cb22-87"><a href="#cb22-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-88"><a href="#cb22-88" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> steps, Q_history</span>
<span id="cb22-89"><a href="#cb22-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-90"><a href="#cb22-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-91"><a href="#cb22-91" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> prepare_plot_episodes_over_steps(steps, figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">6</span>)):</span>
<span id="cb22-92"><a href="#cb22-92" aria-hidden="true" tabindex="-1"></a>    fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>figsize)</span>
<span id="cb22-93"><a href="#cb22-93" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> np.concatenate(([<span class="dv">0</span>], np.cumsum(steps)))</span>
<span id="cb22-94"><a href="#cb22-94" aria-hidden="true" tabindex="-1"></a>    y <span class="op">=</span> np.arange(<span class="bu">len</span>(steps) <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb22-95"><a href="#cb22-95" aria-hidden="true" tabindex="-1"></a>    ax.step(x, y, where<span class="op">=</span><span class="st">"post"</span>)</span>
<span id="cb22-96"><a href="#cb22-96" aria-hidden="true" tabindex="-1"></a>    ax.set_xlabel(<span class="st">"Time Steps"</span>)</span>
<span id="cb22-97"><a href="#cb22-97" aria-hidden="true" tabindex="-1"></a>    ax.set_ylabel(<span class="st">"Episode"</span>)</span>
<span id="cb22-98"><a href="#cb22-98" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> fig, ax</span>
<span id="cb22-99"><a href="#cb22-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-100"><a href="#cb22-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-101"><a href="#cb22-101" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_greedy_policy(env, Q):</span>
<span id="cb22-102"><a href="#cb22-102" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb22-103"><a href="#cb22-103" aria-hidden="true" tabindex="-1"></a>        state: select_greedy_action(state, Q, env.action_space)</span>
<span id="cb22-104"><a href="#cb22-104" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> state <span class="kw">in</span> env.state_space</span>
<span id="cb22-105"><a href="#cb22-105" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb22-106"><a href="#cb22-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-107"><a href="#cb22-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-108"><a href="#cb22-108" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> generate_episode(env, Ï€, max_len<span class="op">=</span><span class="dv">20</span>):</span>
<span id="cb22-109"><a href="#cb22-109" aria-hidden="true" tabindex="-1"></a>    state <span class="op">=</span> env.reset()</span>
<span id="cb22-110"><a href="#cb22-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-111"><a href="#cb22-111" aria-hidden="true" tabindex="-1"></a>    terminated <span class="op">=</span> <span class="va">False</span></span>
<span id="cb22-112"><a href="#cb22-112" aria-hidden="true" tabindex="-1"></a>    states <span class="op">=</span> [state]</span>
<span id="cb22-113"><a href="#cb22-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-114"><a href="#cb22-114" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="kw">not</span> terminated:</span>
<span id="cb22-115"><a href="#cb22-115" aria-hidden="true" tabindex="-1"></a>        action <span class="op">=</span> Ï€[state]</span>
<span id="cb22-116"><a href="#cb22-116" aria-hidden="true" tabindex="-1"></a>        state, terminated <span class="op">=</span> env.step(action)</span>
<span id="cb22-117"><a href="#cb22-117" aria-hidden="true" tabindex="-1"></a>        states.append(state)</span>
<span id="cb22-118"><a href="#cb22-118" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(states) <span class="op">==</span> max_len:</span>
<span id="cb22-119"><a href="#cb22-119" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> states</span>
<span id="cb22-120"><a href="#cb22-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-121"><a href="#cb22-121" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> states</span>
<span id="cb22-122"><a href="#cb22-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-123"><a href="#cb22-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-124"><a href="#cb22-124" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_episode(env, states, title<span class="op">=</span><span class="va">None</span>, radius<span class="op">=</span><span class="fl">0.3</span>, figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">8</span>)):</span>
<span id="cb22-125"><a href="#cb22-125" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb22-126"><a href="#cb22-126" aria-hidden="true" tabindex="-1"></a><span class="co">    Annotate every visit (timestep) but jitter repeated visits around the cell.</span></span>
<span id="cb22-127"><a href="#cb22-127" aria-hidden="true" tabindex="-1"></a><span class="co">    radius: radial offset (in cell units) for jitter ring; increase if labels collide.</span></span>
<span id="cb22-128"><a href="#cb22-128" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb22-129"><a href="#cb22-129" aria-hidden="true" tabindex="-1"></a>    fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>figsize)</span>
<span id="cb22-130"><a href="#cb22-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-131"><a href="#cb22-131" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create a blank grid</span></span>
<span id="cb22-132"><a href="#cb22-132" aria-hidden="true" tabindex="-1"></a>    grid <span class="op">=</span> np.zeros((env.height, env.width))</span>
<span id="cb22-133"><a href="#cb22-133" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Mark start and target positions</span></span>
<span id="cb22-134"><a href="#cb22-134" aria-hidden="true" tabindex="-1"></a>    grid[env.start_pos[<span class="dv">1</span>], env.start_pos[<span class="dv">0</span>]] <span class="op">=</span> <span class="dv">1</span>  <span class="co"># start position</span></span>
<span id="cb22-135"><a href="#cb22-135" aria-hidden="true" tabindex="-1"></a>    grid[env.target_pos[<span class="dv">1</span>], env.target_pos[<span class="dv">0</span>]] <span class="op">=</span> <span class="dv">2</span>  <span class="co"># target position</span></span>
<span id="cb22-136"><a href="#cb22-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-137"><a href="#cb22-137" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Define colormap: background, start, target</span></span>
<span id="cb22-138"><a href="#cb22-138" aria-hidden="true" tabindex="-1"></a>    cmap <span class="op">=</span> ListedColormap(</span>
<span id="cb22-139"><a href="#cb22-139" aria-hidden="true" tabindex="-1"></a>        [<span class="st">"#f2f2f2"</span>, <span class="st">"#8fd18f"</span>, <span class="st">"#e68a8a"</span>]</span>
<span id="cb22-140"><a href="#cb22-140" aria-hidden="true" tabindex="-1"></a>    )  <span class="co"># light gray, light green, light red</span></span>
<span id="cb22-141"><a href="#cb22-141" aria-hidden="true" tabindex="-1"></a>    ax.imshow(grid, cmap<span class="op">=</span>cmap, origin<span class="op">=</span><span class="st">"lower"</span>, interpolation<span class="op">=</span><span class="st">"nearest"</span>)</span>
<span id="cb22-142"><a href="#cb22-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-143"><a href="#cb22-143" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Set ticks and limits</span></span>
<span id="cb22-144"><a href="#cb22-144" aria-hidden="true" tabindex="-1"></a>    ax.set_xticks(np.arange(env.width))</span>
<span id="cb22-145"><a href="#cb22-145" aria-hidden="true" tabindex="-1"></a>    ax.set_yticks(np.arange(env.height))</span>
<span id="cb22-146"><a href="#cb22-146" aria-hidden="true" tabindex="-1"></a>    ax.set_xlim(<span class="op">-</span><span class="fl">0.5</span>, env.width <span class="op">-</span> <span class="fl">0.5</span>)</span>
<span id="cb22-147"><a href="#cb22-147" aria-hidden="true" tabindex="-1"></a>    ax.set_ylim(<span class="op">-</span><span class="fl">0.5</span>, env.height <span class="op">-</span> <span class="fl">0.5</span>)</span>
<span id="cb22-148"><a href="#cb22-148" aria-hidden="true" tabindex="-1"></a>    ax.set_aspect(<span class="st">"equal"</span>)</span>
<span id="cb22-149"><a href="#cb22-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-150"><a href="#cb22-150" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Rotate x-tick labels</span></span>
<span id="cb22-151"><a href="#cb22-151" aria-hidden="true" tabindex="-1"></a>    plt.setp(ax.get_xticklabels(), rotation<span class="op">=</span><span class="dv">45</span>, ha<span class="op">=</span><span class="st">"right"</span>)</span>
<span id="cb22-152"><a href="#cb22-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-153"><a href="#cb22-153" aria-hidden="true" tabindex="-1"></a>    <span class="co"># grid lines</span></span>
<span id="cb22-154"><a href="#cb22-154" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> x <span class="kw">in</span> <span class="bu">range</span>(env.width):</span>
<span id="cb22-155"><a href="#cb22-155" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> y <span class="kw">in</span> <span class="bu">range</span>(env.height):</span>
<span id="cb22-156"><a href="#cb22-156" aria-hidden="true" tabindex="-1"></a>            rect <span class="op">=</span> plt.Rectangle(</span>
<span id="cb22-157"><a href="#cb22-157" aria-hidden="true" tabindex="-1"></a>                (x <span class="op">-</span> <span class="fl">0.5</span>, y <span class="op">-</span> <span class="fl">0.5</span>),</span>
<span id="cb22-158"><a href="#cb22-158" aria-hidden="true" tabindex="-1"></a>                <span class="dv">1</span>,</span>
<span id="cb22-159"><a href="#cb22-159" aria-hidden="true" tabindex="-1"></a>                <span class="dv">1</span>,</span>
<span id="cb22-160"><a href="#cb22-160" aria-hidden="true" tabindex="-1"></a>                fill<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb22-161"><a href="#cb22-161" aria-hidden="true" tabindex="-1"></a>                edgecolor<span class="op">=</span><span class="st">"#444444"</span>,</span>
<span id="cb22-162"><a href="#cb22-162" aria-hidden="true" tabindex="-1"></a>                linewidth<span class="op">=</span><span class="fl">0.1</span>,</span>
<span id="cb22-163"><a href="#cb22-163" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb22-164"><a href="#cb22-164" aria-hidden="true" tabindex="-1"></a>            ax.add_patch(rect)</span>
<span id="cb22-165"><a href="#cb22-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-166"><a href="#cb22-166" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(states) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb22-167"><a href="#cb22-167" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Check if states are objects with a position attribute or just positions</span></span>
<span id="cb22-168"><a href="#cb22-168" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">hasattr</span>(states[<span class="dv">0</span>], <span class="st">"position"</span>):</span>
<span id="cb22-169"><a href="#cb22-169" aria-hidden="true" tabindex="-1"></a>            positions <span class="op">=</span> [s.position <span class="cf">for</span> s <span class="kw">in</span> states]</span>
<span id="cb22-170"><a href="#cb22-170" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb22-171"><a href="#cb22-171" aria-hidden="true" tabindex="-1"></a>            positions <span class="op">=</span> states</span>
<span id="cb22-172"><a href="#cb22-172" aria-hidden="true" tabindex="-1"></a>        xs <span class="op">=</span> [p[<span class="dv">0</span>] <span class="cf">for</span> p <span class="kw">in</span> positions]</span>
<span id="cb22-173"><a href="#cb22-173" aria-hidden="true" tabindex="-1"></a>        ys <span class="op">=</span> [p[<span class="dv">1</span>] <span class="cf">for</span> p <span class="kw">in</span> positions]</span>
<span id="cb22-174"><a href="#cb22-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-175"><a href="#cb22-175" aria-hidden="true" tabindex="-1"></a>        ax.plot(xs, ys, marker<span class="op">=</span><span class="st">"o"</span>)</span>
<span id="cb22-176"><a href="#cb22-176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-177"><a href="#cb22-177" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Build map from position -&gt; list of visit indices</span></span>
<span id="cb22-178"><a href="#cb22-178" aria-hidden="true" tabindex="-1"></a>        visits <span class="op">=</span> {}</span>
<span id="cb22-179"><a href="#cb22-179" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> t, pos <span class="kw">in</span> <span class="bu">enumerate</span>(positions):</span>
<span id="cb22-180"><a href="#cb22-180" aria-hidden="true" tabindex="-1"></a>            visits.setdefault(pos, []).append(t)</span>
<span id="cb22-181"><a href="#cb22-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-182"><a href="#cb22-182" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Annotate each visit with radial offsets to avoid overlap</span></span>
<span id="cb22-183"><a href="#cb22-183" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> pos, idx_list <span class="kw">in</span> visits.items():</span>
<span id="cb22-184"><a href="#cb22-184" aria-hidden="true" tabindex="-1"></a>            x0, y0 <span class="op">=</span> pos</span>
<span id="cb22-185"><a href="#cb22-185" aria-hidden="true" tabindex="-1"></a>            n <span class="op">=</span> <span class="bu">len</span>(idx_list)</span>
<span id="cb22-186"><a href="#cb22-186" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> k, t <span class="kw">in</span> <span class="bu">enumerate</span>(idx_list):</span>
<span id="cb22-187"><a href="#cb22-187" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> n <span class="op">==</span> <span class="dv">1</span>:</span>
<span id="cb22-188"><a href="#cb22-188" aria-hidden="true" tabindex="-1"></a>                    dx, dy <span class="op">=</span> (<span class="fl">0.08</span>, <span class="fl">0.18</span>)</span>
<span id="cb22-189"><a href="#cb22-189" aria-hidden="true" tabindex="-1"></a>                <span class="cf">else</span>:</span>
<span id="cb22-190"><a href="#cb22-190" aria-hidden="true" tabindex="-1"></a>                    angle <span class="op">=</span> <span class="dv">2</span> <span class="op">*</span> math.pi <span class="op">*</span> k <span class="op">/</span> n</span>
<span id="cb22-191"><a href="#cb22-191" aria-hidden="true" tabindex="-1"></a>                    dx <span class="op">=</span> math.cos(angle) <span class="op">*</span> radius</span>
<span id="cb22-192"><a href="#cb22-192" aria-hidden="true" tabindex="-1"></a>                    dy <span class="op">=</span> math.sin(angle) <span class="op">*</span> radius</span>
<span id="cb22-193"><a href="#cb22-193" aria-hidden="true" tabindex="-1"></a>                ax.text(</span>
<span id="cb22-194"><a href="#cb22-194" aria-hidden="true" tabindex="-1"></a>                    x0 <span class="op">+</span> dx,</span>
<span id="cb22-195"><a href="#cb22-195" aria-hidden="true" tabindex="-1"></a>                    y0 <span class="op">+</span> dy,</span>
<span id="cb22-196"><a href="#cb22-196" aria-hidden="true" tabindex="-1"></a>                    <span class="bu">str</span>(t),</span>
<span id="cb22-197"><a href="#cb22-197" aria-hidden="true" tabindex="-1"></a>                    fontsize<span class="op">=</span><span class="dv">9</span>,</span>
<span id="cb22-198"><a href="#cb22-198" aria-hidden="true" tabindex="-1"></a>                    va<span class="op">=</span><span class="st">"center"</span>,</span>
<span id="cb22-199"><a href="#cb22-199" aria-hidden="true" tabindex="-1"></a>                    ha<span class="op">=</span><span class="st">"center"</span>,</span>
<span id="cb22-200"><a href="#cb22-200" aria-hidden="true" tabindex="-1"></a>                    bbox<span class="op">=</span><span class="bu">dict</span>(boxstyle<span class="op">=</span><span class="st">"round,pad=0.1"</span>, alpha<span class="op">=</span><span class="fl">0.9</span>),</span>
<span id="cb22-201"><a href="#cb22-201" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb22-202"><a href="#cb22-202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-203"><a href="#cb22-203" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> title:</span>
<span id="cb22-204"><a href="#cb22-204" aria-hidden="true" tabindex="-1"></a>        ax.set_title(title)</span>
<span id="cb22-205"><a href="#cb22-205" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-206"><a href="#cb22-206" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> fig, ax</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>rng <span class="op">=</span> random.Random(<span class="dv">25</span>)</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>env <span class="op">=</span> WindyGridWorld(rng)</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>Î± <span class="op">=</span> <span class="fl">0.5</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>Îµ <span class="op">=</span> <span class="fl">0.1</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>n_episodes <span class="op">=</span> <span class="dv">170</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>steps, Q_history <span class="op">=</span> windy_grid_world_experiment(</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>    env, n_episodes<span class="op">=</span>n_episodes, Î±<span class="op">=</span>Î±, Îµ<span class="op">=</span>Îµ, rng<span class="op">=</span>rng</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> prepare_plot_episodes_over_steps(steps)</span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="ss">f"SARSA on Windy Grid World, Î±=</span><span class="sc">{Î±}</span><span class="ss">, Îµ=</span><span class="sc">{Îµ}</span><span class="ss">"</span>)</span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a><span class="co"># plt.show()</span></span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a>Ï€ <span class="op">=</span> get_greedy_policy(env, Q_history[<span class="op">-</span><span class="dv">1</span>])</span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a>episode <span class="op">=</span> generate_episode(env, Ï€)</span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a>plot_episode(env, episode)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div id="fig-xxx" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-xxx-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div id="79092762" class="cell" data-execution_count="22">
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="06-temporal-difference-learning_files/figure-html/cell-22-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-12" title="Figure&nbsp;6.7: "><img src="06-temporal-difference-learning_files/figure-html/cell-22-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="06-temporal-difference-learning_files/figure-html/cell-22-output-2.png" class="lightbox" data-gallery="quarto-lightbox-gallery-13" title="Figure&nbsp;6.7: "><img src="06-temporal-difference-learning_files/figure-html/cell-22-output-2.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig quarto-uncaptioned" id="fig-xxx-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;6.7
</figcaption>
</figure>
</div>
</div>


<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-graves2022importance" class="csl-entry" role="listitem">
Graves, Eric, and Sina Ghiassian. 2022. <span>â€œImportance Sampling Placement in Off-Policy Temporal-Difference Methods.â€</span> <em>arXiv Preprint arXiv:2203.10172</em>. <a href="https://doi.org/10.48550/arXiv.2203.10172">https://doi.org/10.48550/arXiv.2203.10172</a>.
</div>
<div id="ref-sutton2018" class="csl-entry" role="listitem">
Sutton, Richard S., and Andrew G. Barto. 2018. <em>Reinforcement Learning: An Introduction</em>. Second edition. Adaptive Computation and Machine Learning Series. Cambridge, MA: MIT Press. <a href="https://mitpress.mit.edu/9780262039246/reinforcement-learning/">https://mitpress.mit.edu/9780262039246/reinforcement-learning/</a>.
</div>
</div>
</section>
<section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes">
<hr>
<ol>
<li id="fn1"><p>In the book, the non-terminal states are labelled <span class="math inline">\(A,B,C,D,E\)</span>.<a href="#fnref1" class="footnote-back" role="doc-backlink">â†©ï¸Ž</a></p></li>
<li id="fn2"><p>In the book this is <span class="math inline">\(V(A)\)</span><a href="#fnref2" class="footnote-back" role="doc-backlink">â†©ï¸Ž</a></p></li>
</ol>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    // Ensure there is a toggle, if there isn't float one in the top right
    if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
      const a = window.document.createElement('a');
      a.classList.add('top-right');
      a.classList.add('quarto-color-scheme-toggle');
      a.href = "";
      a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
      const i = window.document.createElement("i");
      i.classList.add('bi');
      a.appendChild(i);
      window.document.body.appendChild(a);
    }
    setColorSchemeToggle(hasAlternateSentinel())
    const icon = "î§‹";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../chapters/05-monte-carlo-methods.html" class="pagination-link" aria-label="Monte Carlo Methods">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Monte Carlo Methods</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
  </div>
</nav>
</div> <!-- /content -->
<script>var lightboxQuarto = GLightbox({"closeEffect":"zoom","descPosition":"bottom","loop":false,"openEffect":"zoom","selector":".lightbox"});
(function() {
  let previousOnload = window.onload;
  window.onload = () => {
    if (previousOnload) {
      previousOnload();
    }
    lightboxQuarto.on('slide_before_load', (data) => {
      const { slideIndex, slideNode, slideConfig, player, trigger } = data;
      const href = trigger.getAttribute('href');
      if (href !== null) {
        const imgEl = window.document.querySelector(`a[href="${href}"] img`);
        if (imgEl !== null) {
          const srcAttr = imgEl.getAttribute("src");
          if (srcAttr && srcAttr.startsWith("data:")) {
            slideConfig.href = srcAttr;
          }
        }
      } 
    });
  
    lightboxQuarto.on('slide_after_load', (data) => {
      const { slideIndex, slideNode, slideConfig, player, trigger } = data;
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(slideNode);
      }
    });
  
  };
  
})();
          </script>




</body></html>